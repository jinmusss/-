<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JINMU PRO ULTIMATE - 目标矩阵</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        @import url('https://gd-hbimg-edge.huabanimg.com/aac0967a173065d1476e2d267f3724c8957044191969e8-6UW7td_fw1200?auth_key=1766332800-110c79413e7f4ebd825e50c5a9df0bc8-0-900838b741a27ef02ffb2d5a04d7815a');
        
       body {
    /* 图片地址 */
    background-image: url('https://gd-hbimg-edge.huabanimg.com/aac0967a173065d1476e2d267f3724c8957044191969e8-6UW7td_fw658webp?auth_key=1766332800-110c79413e7f4ebd825e50c5a9df0bc8-0-900838b741a27ef02ffb2d5a04d7815a'); 
    
    /* 核心设置：确保图片铺满且不重复 */
    background-size: cover;          /* 缩放背景图以完全覆盖背景区域 */
    background-position: center;      /* 图片居中显示 */
    background-attachment: fixed;    /* 背景固定，不随页面滚动（视差效果） */
    background-repeat: no-repeat;    /* 不重复平铺 */
}
        /* 磨砂玻璃效果增强：为了让内容在复杂背景下更清晰 */
        .component-bg { 
            background-color: rgba(17, 17, 34, 0.85); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(45, 45, 76, 0.5); 
        }

        .input-dark { background-color: rgba(5, 5, 10, 0.8) !important; border: 1px solid #3d3d5c !important; color: white !important; font-size: 14px !important; }
        .hidden-view { display: none !important; }
        
        /* 进度条动画 */
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring__circle { transition: stroke-dashoffset 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); transform-origin: 50% 50%; }

        /* 日历强化 */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .calendar-day { aspect-ratio: 1/1.1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; font-size: 11px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }
        .calendar-day:hover { transform: scale(1.1); z-index: 10; box-shadow: 0 0 15px rgba(0,212,255,0.3); }
        .day-profit { background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.5); color: #10b981; }
        .day-loss { background: rgba(244, 63, 94, 0.2); border: 1px solid rgba(244, 63, 94, 0.5); color: #f43f5e; }
        .day-empty { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); color: #64748b; }
        
        /* 指标卡片 */
        .metric-card { transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1); border-top: 2px solid transparent; }
        .metric-card:hover { border-top-color: #00d4ff; background: rgba(22, 22, 50, 0.9); transform: translateY(-5px); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); }

        .cyber-button { background-image: linear-gradient(135deg, #00d4ff,#8338ec); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border: none; box-shadow: 0 4px 15px rgba(131,56,236,0.3); }
        .cyber-button:hover { box-shadow: 0 0 25px rgba(0,212,255,0.6); transform: scale(1.02); letter-spacing: 1px; }

        /* 强化日志行动画 */
        .trade-row { transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .trade-row:hover { background-color: rgba(26, 26, 53, 0.8); transform: translateX(12px) scale(1.005); box-shadow: -10px 0 20px -10px #00d4ff; }
        
        .action-icon { transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); width: 36px; height: 36px; border-radius: 10px; background: rgba(255,255,255,0.03); }
        .action-icon:hover { transform: scale(1.3) rotate(8deg); background: rgba(0,212,255,0.2); color: #00d4ff; box-shadow: 0 0 15px rgba(0,212,255,0.4); }

        /* 弹窗弹出动画 */
        @keyframes modalIn {
            0% { opacity: 0; transform: scale(0.8) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-animate { animation: modalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #3d3d5c; border-radius: 10px; }
    </style>
</head>
<body class="selection:bg-cyan-600 selection:text-black">

    <!-- Auth View -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center p-4 hidden-view">
        <div class="w-full max-w-md p-10 rounded-3xl component-bg shadow-2xl border-t-8 border-cyan-500">
            <div class="text-center mb-10">
                <i class="fas fa-bolt text-6xl text-cyan-400 mb-6 drop-shadow-[0_0_15px_rgba(34,211,238,0.5)]"></i>
                <h1 class="text-3xl font-black tracking-tighter text-white">JINMU <span class="text-cyan-400">TRADE</span></h1>
                <p class="text-gray-400 text-sm mt-3 font-bold uppercase tracking-widest">Quantum Performance System</p>
            </div>
            <form id="auth-form" class="space-y-6">
                <input type="email" id="auth-email" required class="w-full p-5 rounded-2xl input-dark" placeholder="邮箱账号">
                <input type="password" id="auth-password" required class="w-full p-5 rounded-2xl input-dark" placeholder="密码">
                <button type="submit" class="cyber-button w-full py-5 rounded-2xl font-black uppercase tracking-widest text-lg">进入</button>
                <button type="button" id="btn-register" class="w-full text-gray-500 text-xs hover:text-cyan-400 transition-colors">注册</button>
            </form>
        </div>
    </div>

    <!-- Main View -->
    <div id="main-view" class="hidden-view p-4 md:p-8 max-w-[1700px] mx-auto w-full">
        <header class="mb-8 flex justify-between items-center bg-[#111122]/80 backdrop-blur-md p-6 rounded-3xl border border-white/10 shadow-xl">
            <div class="flex items-center space-x-5">
                <div class="w-12 h-12 bg-cyan-500/10 rounded-xl flex items-center justify-center border border-cyan-500/30 animate-pulse">
                    <i class="fas fa-layer-group text-2xl text-cyan-400"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-wider text-white leading-none">JINMU <span class="text-cyan-400">TRADE</span></h1>
                    <p class="text-[10px] text-gray-400 uppercase font-black tracking-[0.2em] mt-2">Professional Quantitative Hub</p>
                </div>
            </div>
            <div class="flex items-center space-x-6">
                <div class="flex flex-col items-end">
                    <span id="user-display-name" class="text-sm font-black text-white tracking-tight">OPERATOR</span>
                    <span class="flex items-center text-[10px] text-emerald-500 uppercase font-black tracking-tighter">
                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full mr-1.5 animate-ping"></span> online
                    </span>
                </div>
                <div class="h-10 w-[1px] bg-white/10"></div>
                <button id="btn-logout" class="w-10 h-10 rounded-xl bg-rose-500/10 text-rose-500 hover:bg-rose-500 hover:text-white transition-all duration-300 flex items-center justify-center group">
                    <i class="fas fa-power-off group-hover:rotate-90 transition-transform"></i>
                </button>
            </div>
        </header>

        <main class="space-y-8">
            <!-- 顶层：目标进度与设置 + 专业指标 -->
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
                <div class="xl:col-span-5 p-8 rounded-3xl component-bg border border-cyan-500/20 relative overflow-hidden shadow-2xl">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-cyan-500/5 blur-3xl rounded-full"></div>
                    <div class="flex items-center justify-between mb-8">
                        <span class="text-xs text-cyan-400 font-black uppercase tracking-[0.25em]">Account Growth Tracker</span>
                        <i class="fas fa-radar text-gray-700"></i>
                    </div>
                    
                    <div class="flex flex-col md:flex-row items-center gap-10">
                        <div class="relative flex items-center justify-center shrink-0 group">
                            <div class="absolute inset-0 bg-cyan-500/10 blur-2xl rounded-full scale-0 group-hover:scale-110 transition-transform duration-700"></div>
                            <svg class="progress-ring relative" width="140" height="140">
                                <circle class="text-white/5" stroke-width="10" stroke="currentColor" fill="transparent" r="62" cx="70" cy="70"/>
                                <circle id="goal-progress-bar" class="text-cyan-400 progress-ring__circle" stroke-width="10" stroke-dasharray="389.5" stroke-dashoffset="389.5" stroke-linecap="round" stroke="currentColor" fill="transparent" r="62" cx="70" cy="70"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="goal-percent" class="text-3xl font-black text-white tracking-tighter">0%</span>
                            </div>
                        </div>

                        <div class="flex-grow w-full space-y-6">
                            <div class="grid grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-[11px] text-gray-400 uppercase font-black tracking-widest">初始资金 (Base)</label>
                                    <div class="flex items-center bg-black/40 px-4 py-3 rounded-xl border border-white/5 focus-within:border-cyan-500/50 transition-all">
                                        <span class="text-cyan-500 font-black mr-2">$</span>
                                        <input type="number" id="initial-capital" class="bg-transparent border-none p-0 text-white font-black text-base w-full focus:ring-0" value="10000">
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[11px] text-gray-400 uppercase font-black tracking-widest">目标资金 (Target)</label>
                                    <div class="flex items-center bg-black/40 px-4 py-3 rounded-xl border border-white/5 focus-within:border-cyan-500/50 transition-all">
                                        <span class="text-cyan-500 font-black mr-2">$</span>
                                        <input type="number" id="target-capital" class="bg-transparent border-none p-0 text-white font-black text-base w-full focus:ring-0" value="20000">
                                    </div>
                                </div>
                            </div>
                            <div class="pt-4 border-t border-white/5">
                                <p id="remaining-label" class="text-xs text-gray-400 italic font-medium tracking-tight">AI 正在解析目标路径...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="xl:col-span-7 grid grid-cols-2 md:grid-cols-4 gap-5" id="metrics-grid"></div>
            </div>

            <!-- 中间：日历与曲线 -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 xl:col-span-3 p-8 rounded-3xl component-bg border border-white/10 shadow-xl">
                    <div class="flex flex-col space-y-6 mb-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-sm font-black text-white uppercase tracking-widest flex items-center"><i class="fas fa-calendar-alt mr-3 text-cyan-400"></i>交易日历</h3>
                            <div class="flex space-x-2">
                                <button id="btn-7d" class="px-3 py-1.5 text-[10px] bg-white/5 rounded-lg text-gray-400 hover:bg-cyan-500 hover:text-black font-black transition-all">7日</button>
                                <button id="btn-this-month" class="px-3 py-1.5 text-[10px] bg-white/5 rounded-lg text-gray-400 hover:bg-cyan-500 hover:text-black font-black transition-all">本月</button>
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <input type="month" id="calendar-month-select" class="flex-grow bg-[#05050a] border border-[#2d2d4c] text-cyan-400 text-xs px-4 py-3 rounded-xl outline-none font-black">
                            <button onclick="window.changeMonth(-1)" class="w-10 h-10 bg-white/5 rounded-xl hover:text-cyan-400 transition-colors"><i class="fas fa-chevron-left"></i></button>
                            <button onclick="window.changeMonth(1)" class="w-10 h-10 bg-white/5 rounded-xl hover:text-cyan-400 transition-colors"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-[10px] text-gray-600 mb-3 text-center uppercase font-black tracking-widest">
                        <div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div><div>日</div>
                    </div>
                    <div id="calendar-heatmap" class="calendar-grid"></div>
                    <div class="mt-8 pt-6 border-t border-white/5 flex justify-between items-center">
                        <div>
                            <p class="text-[10px] text-gray-500 uppercase font-black tracking-widest mb-1">视图盈亏</p>
                            <p id="view-pnl" class="text-xl font-black font-mono">+$0.00</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-gray-500 uppercase font-black tracking-widest mb-1">交易次数</p>
                            <p id="view-count" class="text-xl font-black font-mono text-white">0</p>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 xl:col-span-9 p-8 rounded-3xl component-bg shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-cyan-500/5 blur-[100px] pointer-events-none"></div>
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-sm font-black text-gray-400 uppercase tracking-[0.3em]"><i class="fas fa-wave-square mr-3 text-cyan-500"></i>Equity Curve Analytics</h3>
                        <div id="curve-range-label" class="text-[10px] text-cyan-400 font-black bg-cyan-500/10 px-4 py-1.5 rounded-full border border-cyan-500/20">ALL TIME VISUALIZER</div>
                    </div>
                    <div class="h-[380px] w-full"><canvas id="equity-chart"></canvas></div>
                </div>
            </div>

            <!-- 底层：交易日志 -->
            <div class="p-8 rounded-3xl component-bg border border-white/10 shadow-2xl">
                <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
                    <div class="flex items-center space-x-6">
                        <h3 class="text-2xl font-black text-white uppercase tracking-tighter">交易日志 <span id="log-count" class="ml-3 px-3 py-1 bg-cyan-500 text-black text-[11px] rounded-lg font-black">0</span></h3>
                        <button onclick="window.openModal()" class="bg-cyan-500 hover:bg-cyan-400 text-black px-8 py-3 rounded-2xl text-sm font-black transition-all shadow-xl shadow-cyan-500/30 active:scale-95">
                            <i class="fas fa-plus-circle mr-2"></i> 录入新成交
                        </button>
                    </div>
                    <div class="flex space-x-3 w-full md:w-auto">
                        <div class="relative flex-grow md:flex-initial">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-600"></i>
                            <input type="text" id="search-input" placeholder="筛选代码 (BTC/ETH)..." class="bg-[#05050a]/60 border border-[#2d2d4c] pl-11 pr-4 py-3 rounded-xl text-xs text-white focus:border-cyan-500 outline-none w-full md:w-56 font-bold transition-all">
                        </div>
                        <select id="filter-status" class="bg-[#05050a]/60 border border-[#2d2d4c] text-white text-xs px-4 py-3 rounded-xl outline-none font-bold">
                            <option value="all">所有状态</option>
                            <option value="win">盈利单</option>
                            <option value="loss">亏损单</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="text-left text-[11px] uppercase text-gray-500 font-black tracking-[0.2em] border-b border-white/5">
                                <th class="px-6 py-6">Timestamp / 成交时间</th>
                                <th class="px-6 py-6">Asset / 品种</th>
                                <th class="px-6 py-6 text-right">PnL / 获利($)</th>
                                <th class="px-6 py-6 text-right">Risk / R值</th>
                                <th class="px-6 py-6 text-center">Bias / 方向</th>
                                <th class="px-6 py-6 text-right">Actions / 操作</th>
                            </tr>
                        </thead>
                        <tbody id="trade-list" class="divide-y divide-white/5 text-sm"></tbody>
                    </table>
                    <div id="empty-state" class="hidden py-24 text-center text-gray-700">
                        <i class="fas fa-terminal text-4xl mb-4 block animate-pulse"></i>
                        <p class="text-xs font-black uppercase tracking-[0.3em]">No Data Packets Found in Current Scope</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Trade Modal -->
    <div id="trade-modal" class="fixed inset-0 hidden flex justify-center items-center p-4 z-50 bg-black/95 backdrop-blur-md">
        <div class="bg-[#111122] border border-[#2d2d4c] p-10 rounded-[2.5rem] w-full max-w-xl shadow-[0_0_100px_-20px_rgba(0,212,255,0.3)] modal-animate">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 class="text-2xl font-black text-white uppercase tracking-tighter">录入成交数据</h3>
                    <p class="text-[10px] text-cyan-500 font-black uppercase mt-1 tracking-widest">Transaction Entry Protocol</p>
                </div>
                <button onclick="window.closeModal()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 text-gray-500 hover:text-white transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <form id="trade-form" class="grid grid-cols-2 gap-6">
                <input type="hidden" id="edit-id">
                
                <div class="col-span-1">
                    <label class="text-[12px] text-white uppercase font-black tracking-widest mb-2 block">交易品种</label>
                    <input id="trade-pair" type="text" placeholder="e.g. BTC/USDT" required class="w-full p-4 bg-[#05050a] text-white rounded-2xl border border-[#3d3d5c] outline-none focus:border-cyan-500 transition-all font-bold">
                </div>
                <div class="col-span-1">
                    <label class="text-[12px] text-white uppercase font-black tracking-widest mb-2 block">盈亏金额 ($)</label>
                    <input id="trade-profit" type="number" step="0.01" required class="w-full p-4 bg-[#05050a] text-white rounded-2xl border border-[#3d3d5c] outline-none focus:border-cyan-500 transition-all font-bold">
                </div>
                <div class="col-span-1">
                    <label class="text-[12px] text-white uppercase font-black tracking-widest mb-2 block">交易方向</label>
                    <select id="trade-direction" class="w-full p-4 bg-[#05050a] text-white rounded-2xl border border-[#3d3d5c] outline-none font-black appearance-none">
                        <option value="Long">LONG / 做多</option>
                        <option value="Short">SHORT / 做空</option>
                    </select>
                </div>
                <div class="col-span-1">
                    <label class="text-[12px] text-white uppercase font-black tracking-widest mb-2 block">R 风险值</label>
                    <input id="trade-r" type="number" step="0.1" required class="w-full p-4 bg-[#05050a] text-white rounded-2xl border border-[#3d3d5c] outline-none focus:border-cyan-500 transition-all font-bold">
                </div>
                <div class="col-span-2">
                    <label class="text-[12px] text-white uppercase font-black tracking-widest mb-2 block">TradingView 图表链接 (可选)</label>
                    <div class="relative">
                        <i class="fas fa-link absolute left-4 top-1/2 -translate-y-1/2 text-cyan-500/50"></i>
                        <input id="trade-tv-link" type="url" placeholder="https://www.tradingview.com/x/..." class="w-full pl-12 pr-4 p-4 bg-[#05050a] text-white rounded-2xl border border-[#3d3d5c] outline-none focus:border-cyan-500 transition-all font-bold">
                    </div>
                </div>
                <div class="col-span-2">
                    <label class="text-[12px] text-white uppercase font-black tracking-widest mb-2 block">成交时间</label>
                    <input id="trade-date" type="datetime-local" required class="w-full p-4 bg-[#05050a] text-white rounded-2xl border border-[#3d3d5c] outline-none focus:border-cyan-500 transition-all font-bold">
                </div>
                
                <button type="submit" class="col-span-2 cyber-button py-5 rounded-2xl font-black uppercase text-base mt-4">保存</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyDhzGgJ-Jjb6Ouztk2aV3WvPHimEJ1wagU","authDomain":"jinmu-c0549.firebaseapp.com","projectId":"jinmu-c0549","storageBucket":"jinmu-c0549.firebasestorage.app","messagingSenderId":"433198268542","appId":"1:433198268542:web:e3a1bb8aedd22c4db8982f"}');
        const appId = 'jinmu-v8-ultra';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allTrades = [];
        let config = { initialCapital: 10000, targetCapital: 20000 };
        let chartInstance = null;
        let viewMode = 'month';

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-view').classList.add('hidden-view');
                document.getElementById('main-view').classList.remove('hidden-view');
                document.getElementById('user-display-name').textContent = user.email.split('@')[0].toUpperCase();
                
                const configRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config');
                const configSnap = await getDoc(configRef);
                if (configSnap.exists()) {
                    config = { ...config, ...configSnap.data() };
                    document.getElementById('initial-capital').value = config.initialCapital;
                    document.getElementById('target-capital').value = config.targetCapital;
                }

                const now = new Date();
                document.getElementById('calendar-month-select').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

                onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'trades'), (snap) => {
                    allTrades = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    refreshUI();
                });
            } else {
                document.getElementById('main-view').classList.add('hidden-view');
                document.getElementById('auth-view').classList.remove('hidden-view');
            }
        });

        const saveConfig = async () => {
            if (!auth.currentUser) return;
            config.initialCapital = parseFloat(document.getElementById('initial-capital').value) || 10000;
            config.targetCapital = parseFloat(document.getElementById('target-capital').value) || 20000;
            await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'settings', 'config'), config);
            refreshUI();
        };
        document.getElementById('initial-capital').onchange = saveConfig;
        document.getElementById('target-capital').onchange = saveConfig;

        function refreshUI() {
            allTrades.sort((a, b) => new Date(a.date) - new Date(b.date));
            const now = new Date();
            let filtered = [];
            if (viewMode === '7d') {
                const limit = new Date(); limit.setDate(now.getDate() - 7);
                filtered = allTrades.filter(t => new Date(t.date) >= limit);
            } else {
                const monthVal = document.getElementById('calendar-month-select').value;
                const [y, m] = monthVal.split('-').map(Number);
                filtered = allTrades.filter(t => {
                    const d = new Date(t.date);
                    return d.getFullYear() === y && (d.getMonth() + 1) === m;
                });
            }
            updateGoalProgress(allTrades);
            updateMetricCards(allTrades);
            renderCalendar(allTrades);
            renderTradeList(filtered);
            updateChart(allTrades, filtered);
        }

        function updateGoalProgress(all) {
            const initial = config.initialCapital;
            const target = config.targetCapital;
            let currentEquity = initial;
            all.forEach(t => currentEquity += t.profit);
            const neededToEarn = target - initial;
            const alreadyEarned = currentEquity - initial;
            let progress = neededToEarn > 0 ? Math.max(0, (alreadyEarned / neededToEarn) * 100) : 0;
            document.getElementById('goal-percent').textContent = `${progress.toFixed(1)}%`;
            const circle = document.getElementById('goal-progress-bar');
            const circumference = 389.5; 
            circle.style.strokeDashoffset = circumference - (Math.min(100, progress) / 100 * circumference);
            const remaining = target - currentEquity;
            document.getElementById('remaining-label').textContent = remaining > 0 ? `距目标还差 $${remaining.toLocaleString()}` : 'GOAL REACHED / 目标已达成';
            document.getElementById('remaining-label').className = remaining > 0 ? 'text-xs text-gray-400 italic font-bold' : 'text-xs text-emerald-400 font-black animate-pulse';
        }

        function updateMetricCards(all) {
            const initial = config.initialCapital;
            let currentEquity = initial;
            let maxEquity = initial;
            let maxDD = 0, totalProfit = 0, totalLoss = 0, winCount = 0, lossCount = 0, totalR = 0;
            all.forEach(t => {
                currentEquity += t.profit;
                totalR += t.r;
                if (t.profit > 0) { totalProfit += t.profit; winCount++; }
                else { totalLoss += Math.abs(t.profit); lossCount++; }
                if (currentEquity > maxEquity) maxEquity = currentEquity;
                const dd = ((maxEquity - currentEquity) / maxEquity) * 100;
                if (dd > maxDD) maxDD = dd;
            });
            const wr = all.length ? (winCount / all.length * 100) : 0;
            const pf = totalLoss === 0 ? totalProfit : (totalProfit / totalLoss);
            
            const metrics = [
                { label: '账户总资产', val: `$${currentEquity.toFixed(2)}`, sub: 'Current Balance', cls: 'text-white' },
                { label: '统计胜率', val: `${wr.toFixed(1)}%`, sub: `${winCount}W / ${lossCount}L`, cls: 'text-cyan-400' },
                { label: '盈亏系数 PF', val: pf.toFixed(2), sub: 'Profit Factor', cls: pf >= 1.5 ? 'text-emerald-400' : 'text-amber-400' },
                { label: '极限回撤 DD', val: `${maxDD.toFixed(1)}%`, sub: 'Max Drawdown', cls: 'text-rose-400' },
                { label: '单笔均值 R', val: `${(totalR/Math.max(1,all.length)).toFixed(2)}R`, sub: 'Avg Risk Multiplier', cls: 'text-indigo-400' },
                { label: '期望值 EXP', val: `$${all.length ? ((totalProfit - totalLoss) / all.length).toFixed(2) : 0}`, sub: 'Math Expectancy', cls: 'text-emerald-500' },
                { label: '核心净利润', val: `$${(currentEquity - initial).toFixed(2)}`, sub: 'Absolute Profit', cls: (currentEquity >= initial) ? 'text-emerald-400' : 'text-rose-400' },
                { label: '总成交样本', val: all.length, sub: 'Log Samples', cls: 'text-gray-400' }
            ];
            document.getElementById('metrics-grid').innerHTML = metrics.map(m => `
                <div class="metric-card p-6 rounded-2xl component-bg border border-white/5">
                    <p class="text-[11px] uppercase text-gray-500 font-black tracking-widest mb-3">${m.label}</p>
                    <p class="text-2xl font-black ${m.cls}">${m.val}</p>
                    <p class="text-[10px] text-gray-600 mt-2 uppercase font-black tracking-tight">${m.sub}</p>
                </div>`).join('');
        }

        function renderCalendar(data) {
            const monthVal = document.getElementById('calendar-month-select').value;
            const [year, month0] = monthVal.split('-').map(Number);
            const month = month0 - 1;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startOffset = (firstDay === 0 ? 6 : firstDay - 1);
            const dailyPnL = {};
            data.forEach(t => {
                const d = new Date(t.date);
                if (d.getFullYear() === year && d.getMonth() === month) {
                    const day = d.getDate();
                    dailyPnL[day] = (dailyPnL[day] || 0) + t.profit;
                }
            });
            let html = '';
            for (let i = 0; i < startOffset; i++) html += '<div class="calendar-day opacity-0 pointer-events-none"></div>';
            for (let d = 1; d <= daysInMonth; d++) {
                const pnl = dailyPnL[d];
                let cls = 'day-empty', pnlLabel = '';
                if (pnl !== undefined) { 
                    cls = pnl >= 0 ? 'day-profit' : 'day-loss'; 
                    pnlLabel = `<span class="font-black mt-1">${pnl >= 0 ? '+' : ''}${Math.round(pnl)}</span>`; 
                }
                html += `<div class="calendar-day ${cls} cursor-pointer group"><span class="opacity-50 font-bold group-hover:opacity-100">${d}</span>${pnlLabel}</div>`;
            }
            document.getElementById('calendar-heatmap').innerHTML = html;
        }

        function renderTradeList(filteredData) {
            const search = document.getElementById('search-input').value.toUpperCase();
            const status = document.getElementById('filter-status').value;
            const list = filteredData.filter(t => {
                const matchSearch = t.pair.includes(search);
                const matchStatus = status === 'all' || (status === 'win' ? t.profit > 0 : t.profit <= 0);
                return matchSearch && matchStatus;
            });
            const body = document.getElementById('trade-list');
            const empty = document.getElementById('empty-state');
            document.getElementById('log-count').textContent = list.length;
            if (list.length === 0) { body.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            body.innerHTML = list.slice().reverse().map(t => {
                const tvLink = t.tvLink || `https://www.tradingview.com/chart/?symbol=${t.pair.replace('/','')}`;
                return `
                <tr class="trade-row border-b border-white/5">
                    <td class="px-6 py-6 text-gray-400 font-mono text-[11px] font-bold">${new Date(t.date).toLocaleString()}</td>
                    <td class="px-6 py-6 font-black text-white text-lg tracking-tight">${t.pair}</td>
                    <td class="px-6 py-6 text-right font-black text-xl ${t.profit >= 0 ? 'text-[#10b981]' : 'text-[#ff4b5c]'}">${t.profit >= 0 ? '+' : ''}${t.profit.toFixed(2)}</td>
                    <td class="px-6 py-6 text-right text-indigo-400 font-black text-lg">${t.r}R</td>
                    <td class="px-6 py-6 text-center">
                        <span class="px-4 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest ${t.direction === 'Long' ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'bg-rose-500/10 text-rose-400 border border-rose-500/20'}">
                            ${t.direction}
                        </span>
                    </td>
                    <td class="px-6 py-6 text-right">
                        <div class="flex items-center justify-end space-x-3">
                            <a href="${tvLink}" target="_blank" class="action-icon text-cyan-400 flex items-center justify-center" title="TradingView 图表">
                                <i class="fas fa-chart-line"></i>
                            </a>
                            <button onclick="window.editTrade('${t.id}')" class="action-icon text-gray-400 hover:text-white flex items-center justify-center">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="window.deleteTrade('${t.id}')" class="action-icon text-gray-600 hover:text-rose-500 flex items-center justify-center">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function updateChart(all, viewData) {
            const initial = config.initialCapital;
            let currentViewPnL = 0, baseEquity = initial;
            if (viewData.length > 0) {
                const firstDate = new Date(viewData[0].date);
                all.forEach(t => { if (new Date(t.date) < firstDate) baseEquity += t.profit; });
            }
            const pts = [];
            if (viewData.length > 0) {
                pts.push({ x: new Date(viewData[0].date), y: baseEquity });
                let running = baseEquity;
                viewData.forEach(t => { running += t.profit; currentViewPnL += t.profit; pts.push({ x: new Date(t.date), y: running }); });
            }
            document.getElementById('view-pnl').textContent = `${currentViewPnL >= 0 ? '+' : ''}$${currentViewPnL.toFixed(2)}`;
            document.getElementById('view-pnl').className = `text-2xl font-black font-mono mt-1 ${currentViewPnL >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
            document.getElementById('view-count').textContent = viewData.length;
            
            const ctx = document.getElementById('equity-chart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { datasets: [{ 
                    data: pts, borderColor: '#00d4ff', borderWidth: 3, pointRadius: 4, pointBackgroundColor: '#00d4ff', fill: true,
                    backgroundColor: (c) => { 
                        const g = c.chart.ctx.createLinearGradient(0, 0, 0, 400); 
                        g.addColorStop(0, 'rgba(0, 212, 255, 0.2)'); 
                        g.addColorStop(1, 'rgba(0, 212, 255, 0)'); 
                        return g; 
                    },
                    tension: 0.15 
                }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false }, tooltip: { padding: 12, backgroundColor: '#111122', titleFont: { size: 12, weight: 'bold' }, bodyFont: { size: 14, weight: 'black' } } },
                    scales: { 
                        x: { type: 'time', grid: { display: false }, ticks: { color: '#4b5563', font: {size: 10, weight: 'bold'} } }, 
                        y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#4b5563', font: {size: 10, weight: 'bold'} } } 
                    } 
                }
            });
        }

        window.changeMonth = (off) => {
            const el = document.getElementById('calendar-month-select');
            const [y, m] = el.value.split('-').map(Number);
            const date = new Date(y, m - 1 + off, 1);
            el.value = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
            viewMode = 'month'; refreshUI();
        };

        document.getElementById('btn-7d').onclick = () => { viewMode = '7d'; refreshUI(); };
        document.getElementById('btn-this-month').onclick = () => { viewMode = 'month'; refreshUI(); };
        document.getElementById('calendar-month-select').onchange = () => { viewMode = 'month'; refreshUI(); };
        document.getElementById('search-input').oninput = refreshUI;
        document.getElementById('filter-status').onchange = refreshUI;

        window.openModal = () => {
            document.getElementById('trade-form').reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('trade-date').value = new Date().toISOString().slice(0, 16);
            document.getElementById('trade-modal').classList.remove('hidden');
        };
        window.closeModal = () => document.getElementById('trade-modal').classList.add('hidden');
        
        document.getElementById('trade-form').onsubmit = async (e) => {
            e.preventDefault();
            const trade = { 
                pair: document.getElementById('trade-pair').value.toUpperCase(), 
                profit: parseFloat(document.getElementById('trade-profit').value), 
                direction: document.getElementById('trade-direction').value, 
                r: parseFloat(document.getElementById('trade-r').value), 
                tvLink: document.getElementById('trade-tv-link').value,
                date: document.getElementById('trade-date').value 
            };
            const eid = document.getElementById('edit-id').value;
            if (eid) await updateDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'trades', eid), trade);
            else await addDoc(collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'trades'), trade);
            window.closeModal();
        };

        window.deleteTrade = async (id) => { 
            if(confirm("IDENTIFY THREAT: 确定彻底抹除此条成交记录吗？")) 
                await deleteDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'trades', id)); 
        };

        window.editTrade = (id) => {
            const t = allTrades.find(x => x.id === id);
            document.getElementById('edit-id').value = t.id;
            document.getElementById('trade-pair').value = t.pair;
            document.getElementById('trade-profit').value = t.profit;
            document.getElementById('trade-direction').value = t.direction;
            document.getElementById('trade-r').value = t.r;
            document.getElementById('trade-tv-link').value = t.tvLink || "";
            document.getElementById('trade-date').value = t.date;
            document.getElementById('trade-modal').classList.remove('hidden');
        };

        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value); } catch (err) { alert("ERROR: 访问被拒绝 - " + err.message); }
        };
        document.getElementById('btn-register').onclick = async () => {
            try { await createUserWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value); } catch (err) { alert("ERROR: 身份注册失败 - " + err.message); }
        };
        document.getElementById('btn-logout').onclick = () => signOut(auth);
    </script>
</body>
</html>



















