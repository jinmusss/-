<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JINMU PRO ULTIMATE - ç›®æ ‡çŸ©é˜µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #0d0d18; color: #e2e8f0; min-height: 100vh; }
        .component-bg { background-color: #1a1a2e; border: 1px solid #2d2d4c; }
        .input-dark { background-color: #0d0d18 !important; border: 1px solid #2d2d4c !important; color: white !important; }
        .hidden-view { display: none !important; }
        
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring__circle { transition: stroke-dashoffset 0.5s ease; transform-origin: 50% 50%; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .calendar-day { aspect-ratio: 1/1.1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 10px; transition: all 0.2s; position: relative; }
        .day-profit { background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.4); color: #10b981; }
        .day-loss { background: rgba(244, 63, 94, 0.15); border: 1px solid rgba(244, 63, 94, 0.4); color: #f43f5e; }
        .day-empty { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); color: #4b5563; }
        
        .metric-card { transition: all 0.3s; border-left: 3px solid transparent; }
        .metric-card:hover { border-left-color: #00d4ff; background: rgba(255,255,255,0.02); }

        .cyber-button { background-image: linear-gradient(90deg, #00d4ff,#8338ec); color: white; transition: all 0.2s; cursor: pointer; border: none; }
        .cyber-button:hover { box-shadow: 0 0 20px rgba(131,56,236,0.4); transform: translateY(-1px); }

        /* æ—¥å¿—è¡Œå¤¸å¼ åŠ¨ç”» */
        .trade-row { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: default; }
        .trade-row:hover { background-color: rgba(255, 255, 255, 0.05); transform: translateX(8px); }
        
        .action-icon { transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 8px; }
        .action-icon:hover { background: rgba(255,255,255,0.1); transform: scale(1.2); filter: drop-shadow(0 0 8px currentColor); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #2d2d4c; border-radius: 10px; }
    </style>
</head>
<body class="selection:bg-cyan-600 selection:text-black">

    <!-- Auth View -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center p-4 hidden-view">
        <div class="w-full max-w-md p-8 rounded-2xl component-bg shadow-2xl border-t-4 border-cyan-500">
            <div class="text-center mb-8">
                <i class="fas fa-bolt text-5xl text-cyan-400 mb-4"></i>
                <h1 class="text-2xl font-black tracking-tighter text-white">JINMU <span class="text-cyan-400">CORE</span></h1>
                <p class="text-gray-500 text-xs mt-2">ä¸“ä¸šäº¤æ˜“ç›‘æ§ç³»ç»Ÿ</p>
            </div>
            <form id="auth-form" class="space-y-4">
                <input type="email" id="auth-email" required class="w-full p-4 rounded-xl input-dark" placeholder="é‚®ç®±">
                <input type="password" id="auth-password" required class="w-full p-4 rounded-xl input-dark" placeholder="å¯†ç ">
                <button type="submit" class="cyber-button w-full py-4 rounded-xl font-bold uppercase tracking-widest">è¿›å…¥çŸ©é˜µ</button>
                <button type="button" id="btn-register" class="w-full text-gray-500 text-xs hover:text-cyan-400 mt-2">æ³¨å†Œæ–°è´¦å·</button>
            </form>
        </div>
    </div>

    <!-- Main View -->
    <div id="main-view" class="hidden-view p-4 md:p-6 max-w-[1600px] mx-auto w-full">
        <header class="mb-6 flex justify-between items-center bg-[#1a1a2e] p-4 rounded-2xl border border-white/5">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-cyan-500/10 rounded-lg flex items-center justify-center border border-cyan-500/20">
                    <i class="fas fa-layer-group text-xl text-cyan-400"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black tracking-wider text-white leading-none">JINMU <span class="text-cyan-400">MATRIX</span></h1>
                    <p class="text-[9px] text-gray-500 uppercase tracking-widest mt-1">Quantitative Performance Dashboard</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex flex-col items-end">
                    <span id="user-display-name" class="text-xs font-bold text-gray-300 tracking-tight">User</span>
                    <span class="text-[9px] text-cyan-500 uppercase font-black">Online</span>
                </div>
                <div class="h-8 w-[1px] bg-white/10 mx-2"></div>
                <button id="btn-logout" class="w-8 h-8 rounded-lg bg-rose-500/10 text-rose-500 hover:bg-rose-500 hover:text-white transition-all flex items-center justify-center">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <main class="space-y-6">
            <!-- é¡¶å±‚ï¼šç›®æ ‡è¿›åº¦ä¸è®¾ç½® + ä¸“ä¸šæŒ‡æ ‡ -->
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
                <!-- ç›®æ ‡è¿›åº¦ä¸è®¾ç½®æ•´åˆæ¨¡å— -->
                <div class="xl:col-span-5 p-5 rounded-2xl component-bg border border-cyan-500/20 relative overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Account Growth Tracker</span>
                        <i class="fas fa-bullseye text-cyan-500/30 text-xs"></i>
                    </div>
                    
                    <div class="flex flex-col md:flex-row items-center gap-8">
                        <div class="relative flex items-center justify-center shrink-0">
                            <svg class="progress-ring" width="120" height="120">
                                <circle class="text-gray-800/40" stroke-width="8" stroke="currentColor" fill="transparent" r="54" cx="60" cy="60"/>
                                <circle id="goal-progress-bar" class="text-cyan-400 progress-ring__circle" stroke-width="8" stroke-dasharray="339.3" stroke-dashoffset="339.3" stroke-linecap="round" stroke="currentColor" fill="transparent" r="54" cx="60" cy="60"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="goal-percent" class="text-2xl font-black text-white">0%</span>
                            </div>
                        </div>

                        <div class="flex-grow w-full space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label class="text-[9px] text-gray-500 uppercase font-bold">åˆå§‹èµ„é‡‘</label>
                                    <div class="flex items-center bg-black/30 px-3 py-2 rounded-lg border border-white/5">
                                        <span class="text-cyan-500 text-[10px] mr-1">$</span>
                                        <input type="number" id="initial-capital" class="bg-transparent border-none p-0 text-white font-black text-xs w-full focus:ring-0" value="10000">
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[9px] text-gray-500 uppercase font-bold">ç›®æ ‡èµ„é‡‘</label>
                                    <div class="flex items-center bg-black/30 px-3 py-2 rounded-lg border border-white/5">
                                        <span class="text-cyan-500 text-[10px] mr-1">$</span>
                                        <input type="number" id="target-capital" class="bg-transparent border-none p-0 text-white font-black text-xs w-full focus:ring-0" value="20000">
                                    </div>
                                </div>
                            </div>
                            <div class="pt-2 border-t border-white/5">
                                <p id="remaining-label" class="text-[10px] text-gray-400 italic">æ­£åœ¨è®¡ç®—ç›®æ ‡è·ç¦»...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="xl:col-span-7 grid grid-cols-2 md:grid-cols-4 gap-4" id="metrics-grid"></div>
            </div>

            <!-- ä¸­é—´ï¼šæ—¥å†ä¸æ›²çº¿è”åŠ¨ -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 xl:col-span-3 p-6 rounded-2xl component-bg border border-white/5">
                    <div class="flex flex-col space-y-4 mb-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-sm font-bold text-white uppercase flex items-center"><i class="fas fa-th mr-2 text-cyan-400"></i>äº¤æ˜“çƒ­åŠ›å›¾</h3>
                            <div class="flex space-x-1">
                                <button id="btn-7d" class="px-2 py-1 text-[9px] bg-gray-800 rounded text-gray-400 hover:bg-cyan-500 hover:text-black transition-all">è¿‘7æ—¥</button>
                                <button id="btn-this-month" class="px-2 py-1 text-[9px] bg-gray-800 rounded text-gray-400 hover:bg-cyan-500 hover:text-black transition-all">æœ¬æœˆ</button>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <input type="month" id="calendar-month-select" class="flex-grow bg-[#0d0d18] border border-[#2d2d4c] text-cyan-400 text-xs px-3 py-2 rounded-lg outline-none">
                            <button onclick="window.changeMonth(-1)" class="p-2 bg-gray-800 rounded-lg hover:text-cyan-400"><i class="fas fa-chevron-left"></i></button>
                            <button onclick="window.changeMonth(1)" class="p-2 bg-gray-800 rounded-lg hover:text-cyan-400"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-[9px] text-gray-600 mb-2 text-center uppercase font-bold">
                        <div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div><div>æ—¥</div>
                    </div>
                    <div id="calendar-heatmap" class="calendar-grid"></div>
                    <div class="mt-4 pt-4 border-t border-gray-800 flex justify-between items-center">
                        <div>
                            <p class="text-[9px] text-gray-500 uppercase leading-none">è§†å›¾å‘¨æœŸç›ˆäº</p>
                            <p id="view-pnl" class="text-lg font-black font-mono mt-1">+$0.00</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] text-gray-500 uppercase leading-none">äº¤æ˜“é¢‘ç‡</p>
                            <p id="view-count" class="text-lg font-black font-mono mt-1 text-white">0</p>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 xl:col-span-9 p-6 rounded-2xl component-bg shadow-2xl relative">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest"><i class="fas fa-chart-line mr-2 text-cyan-500"></i>Equity Curve (Filtered)</h3>
                        <div id="curve-range-label" class="text-[10px] text-gray-500 bg-black/40 px-3 py-1 rounded-full border border-white/5">All Time</div>
                    </div>
                    <div class="h-[320px] w-full"><canvas id="equity-chart"></canvas></div>
                </div>
            </div>

            <!-- åº•å±‚ï¼šäº¤æ˜“æ—¥å¿— (å·²å¼ºåŒ–å­—ä½“ä¸é“¾æ¥) -->
            <div class="p-6 rounded-2xl component-bg border border-white/5">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="flex items-center space-x-4">
                        <h3 class="text-lg font-black text-white uppercase tracking-tighter">æ—¥å¿—è®°å½• <span id="log-count" class="ml-2 text-cyan-500 text-xs">0</span></h3>
                        <button onclick="window.openModal()" class="bg-cyan-500 hover:bg-cyan-400 text-black px-6 py-2 rounded-lg text-xs font-black transition-all shadow-lg shadow-cyan-500/20">
                            <i class="fas fa-plus mr-1"></i> æ–°ç¬”äº¤æ˜“
                        </button>
                    </div>
                    <div class="flex space-x-2 w-full md:w-auto">
                        <input type="text" id="search-input" placeholder="ç­›é€‰ä»£ç ..." class="bg-[#0d0d18] border border-[#2d2d4c] px-4 py-2 rounded-lg text-xs text-white focus:border-cyan-500 outline-none w-40">
                        <select id="filter-status" class="bg-[#0d0d18] border border-[#2d2d4c] text-gray-400 text-xs px-3 py-2 rounded-lg outline-none">
                            <option value="all">æ‰€æœ‰çŠ¶æ€</option>
                            <option value="win">ä»…ç›ˆåˆ©</option>
                            <option value="loss">ä»…äºæŸ</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="text-left text-[11px] uppercase text-gray-500 border-b border-gray-800/50">
                                <th class="px-5 py-5">æˆäº¤æ—¶é—´</th>
                                <th class="px-5 py-5">äº¤æ˜“å“ç§</th>
                                <th class="px-5 py-5 text-right">è·åˆ© ($)</th>
                                <th class="px-5 py-5 text-right">Risk (R)</th>
                                <th class="px-5 py-5 text-center">å¤šç©º</th>
                                <th class="px-5 py-5 text-right">æ“ä½œ / é“¾æ¥</th>
                            </tr>
                        </thead>
                        <tbody id="trade-list" class="divide-y divide-gray-800/30 text-sm"></tbody>
                    </table>
                    <div id="empty-state" class="hidden py-12 text-center text-gray-600 text-xs uppercase tracking-widest">
                        <i class="fas fa-inbox text-2xl mb-2 block"></i> æ‰€é€‰æ—¶é—´æ®µå†…æ— äº¤æ˜“è®°å½•
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Trade Modal -->
    <div id="trade-modal" class="fixed inset-0 hidden flex justify-center items-center p-4 z-50 bg-black/90 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] border border-[#2d2d4c] p-8 rounded-2xl w-full max-w-lg shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black text-white uppercase tracking-tighter">å½•å…¥äº¤æ˜“æ•°æ®</h3>
                <button onclick="window.closeModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form id="trade-form" class="grid grid-cols-2 gap-5">
                <input type="hidden" id="edit-id">
                <div class="col-span-1">
                    <label class="text-[10px] text-gray-500 uppercase font-bold">äº¤æ˜“å“ç§</label>
                    <input id="trade-pair" type="text" placeholder="e.g. BTC/USDT" required class="w-full p-3 bg-[#0d0d18] text-white rounded-xl mt-1 border border-[#2d2d4c] outline-none focus:border-cyan-500 transition-all">
                </div>
                <div class="col-span-1">
                    <label class="text-[10px] text-gray-500 uppercase font-bold">ç›ˆäºé‡‘é¢ ($)</label>
                    <input id="trade-profit" type="number" step="0.01" required class="w-full p-3 bg-[#0d0d18] text-white rounded-xl mt-1 border border-[#2d2d4c] outline-none focus:border-cyan-500 transition-all">
                </div>
                <div class="col-span-1">
                    <label class="text-[10px] text-gray-500 uppercase font-bold">äº¤æ˜“æ–¹å‘</label>
                    <select id="trade-direction" class="w-full p-3 bg-[#0d0d18] text-white rounded-xl mt-1 border border-[#2d2d4c] outline-none">
                        <option value="Long">LONG / å¤š</option>
                        <option value="Short">SHORT / ç©º</option>
                    </select>
                </div>
                <div class="col-span-1">
                    <label class="text-[10px] text-gray-500 uppercase font-bold">R é£é™©å€¼</label>
                    <input id="trade-r" type="number" step="0.1" required class="w-full p-3 bg-[#0d0d18] text-white rounded-xl mt-1 border border-[#2d2d4c] outline-none focus:border-cyan-500 transition-all">
                </div>
                <div class="col-span-2">
                    <label class="text-[10px] text-gray-500 uppercase font-bold">æˆäº¤æ—¶é—´</label>
                    <input id="trade-date" type="datetime-local" required class="w-full p-3 bg-[#0d0d18] text-white rounded-xl mt-1 border border-[#2d2d4c] outline-none focus:border-cyan-500 transition-all">
                </div>
                <button type="submit" class="col-span-2 cyber-button py-4 rounded-xl font-black uppercase text-sm mt-2">ä¿å­˜äº¤æ˜“</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyDhzGgJ-Jjb6Ouztk2aV3WvPHimEJ1wagU","authDomain":"jinmu-c0549.firebaseapp.com","projectId":"jinmu-c0549","storageBucket":"jinmu-c0549.firebasestorage.app","messagingSenderId":"433198268542","appId":"1:433198268542:web:e3a1bb8aedd22c4db8982f"}');
        const appId = 'jinmu-v7-final';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allTrades = [];
        let config = { initialCapital: 10000, targetCapital: 20000 };
        let chartInstance = null;
        let viewMode = 'month';

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-view').classList.add('hidden-view');
                document.getElementById('main-view').classList.remove('hidden-view');
                document.getElementById('user-display-name').textContent = user.email.split('@')[0].toUpperCase();
                
                const configRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config');
                const configSnap = await getDoc(configRef);
                if (configSnap.exists()) {
                    config = { ...config, ...configSnap.data() };
                    document.getElementById('initial-capital').value = config.initialCapital;
                    document.getElementById('target-capital').value = config.targetCapital;
                }

                const now = new Date();
                document.getElementById('calendar-month-select').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

                onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'trades'), (snap) => {
                    allTrades = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    refreshUI();
                });
            } else {
                document.getElementById('main-view').classList.add('hidden-view');
                document.getElementById('auth-view').classList.remove('hidden-view');
            }
        });

        const saveConfig = async () => {
            if (!auth.currentUser) return;
            config.initialCapital = parseFloat(document.getElementById('initial-capital').value) || 10000;
            config.targetCapital = parseFloat(document.getElementById('target-capital').value) || 20000;
            await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'settings', 'config'), config);
            refreshUI();
        };
        document.getElementById('initial-capital').onchange = saveConfig;
        document.getElementById('target-capital').onchange = saveConfig;

        function refreshUI() {
            allTrades.sort((a, b) => new Date(a.date) - new Date(b.date));
            const now = new Date();
            let filtered = [];
            if (viewMode === '7d') {
                const limit = new Date(); limit.setDate(now.getDate() - 7);
                filtered = allTrades.filter(t => new Date(t.date) >= limit);
            } else {
                const monthVal = document.getElementById('calendar-month-select').value;
                const [y, m] = monthVal.split('-').map(Number);
                filtered = allTrades.filter(t => {
                    const d = new Date(t.date);
                    return d.getFullYear() === y && (d.getMonth() + 1) === m;
                });
            }
            updateGoalProgress(allTrades);
            updateMetricCards(allTrades);
            renderCalendar(allTrades);
            renderTradeList(filtered);
            updateChart(allTrades, filtered);
        }

        function updateGoalProgress(all) {
            const initial = config.initialCapital;
            const target = config.targetCapital;
            let currentEquity = initial;
            all.forEach(t => currentEquity += t.profit);
            const neededToEarn = target - initial;
            const alreadyEarned = currentEquity - initial;
            let progress = neededToEarn > 0 ? Math.max(0, (alreadyEarned / neededToEarn) * 100) : 0;
            document.getElementById('goal-percent').textContent = `${progress.toFixed(1)}%`;
            const circle = document.getElementById('goal-progress-bar');
            const circumference = 339.3; 
            circle.style.strokeDashoffset = circumference - (Math.min(100, progress) / 100 * circumference);
            const remaining = target - currentEquity;
            document.getElementById('remaining-label').textContent = remaining > 0 ? `è·ç›®æ ‡è¿˜å·® $${remaining.toFixed(2)}` : 'ğŸ‰ å·²è¾¾æˆç›®æ ‡é¢ï¼';
            document.getElementById('remaining-label').className = remaining > 0 ? 'text-[10px] text-gray-400 italic' : 'text-[10px] text-emerald-400 font-bold';
        }

        function updateMetricCards(all) {
            const initial = config.initialCapital;
            let currentEquity = initial;
            let maxEquity = initial;
            let maxDD = 0, totalProfit = 0, totalLoss = 0, winCount = 0, lossCount = 0, totalR = 0;
            all.forEach(t => {
                currentEquity += t.profit;
                totalR += t.r;
                if (t.profit > 0) { totalProfit += t.profit; winCount++; }
                else { totalLoss += Math.abs(t.profit); lossCount++; }
                if (currentEquity > maxEquity) maxEquity = currentEquity;
                const dd = ((maxEquity - currentEquity) / maxEquity) * 100;
                if (dd > maxDD) maxDD = dd;
            });
            const wr = all.length ? (winCount / all.length * 100) : 0;
            const pf = totalLoss === 0 ? totalProfit : (totalProfit / totalLoss);
            const expectancy = all.length ? ((totalProfit - totalLoss) / all.length) : 0;
            const metrics = [
                { label: 'è´¦æˆ·æ€»æƒç›Š', val: `$${currentEquity.toFixed(2)}`, sub: 'Balance', cls: 'text-white' },
                { label: 'èƒœç‡ (Win Rate)', val: `${wr.toFixed(1)}%`, sub: `æ ·æœ¬: ${all.length}`, cls: 'text-cyan-400' },
                { label: 'ç›ˆäºæ¯” (PF)', val: pf.toFixed(2), sub: 'Profit Factor', cls: pf >= 1.5 ? 'text-emerald-400' : 'text-amber-400' },
                { label: 'æœ€å¤§å›æ’¤ (DD)', val: `${maxDD.toFixed(1)}%`, sub: 'Max Drawdown', cls: 'text-rose-400' },
                { label: 'é£é™© R å€¼', val: `${(totalR/Math.max(1,all.length)).toFixed(2)}R`, sub: 'Avg Risk', cls: 'text-indigo-400' },
                { label: 'æœŸæœ›å€¼ (Exp)', val: `$${expectancy.toFixed(2)}`, sub: 'Expectancy', cls: expectancy >= 0 ? 'text-emerald-400' : 'text-rose-400' },
                { label: 'å‡€åˆ©æ¶¦', val: `$${(currentEquity - initial).toFixed(2)}`, sub: 'Net Profit', cls: (currentEquity >= initial) ? 'text-emerald-400' : 'text-rose-400' },
                { label: 'ä¼°è®¡æ‰‹ç»­è´¹', val: `$${(all.length * 2.5).toFixed(2)}`, sub: 'Fee Est.', cls: 'text-gray-500' }
            ];
            document.getElementById('metrics-grid').innerHTML = metrics.map(m => `<div class="metric-card p-4 rounded-xl component-bg border border-white/5"><p class="text-[8px] uppercase text-gray-500 font-black tracking-widest leading-none mb-2">${m.label}</p><p class="text-lg font-black ${m.cls}">${m.val}</p><p class="text-[8px] text-gray-600 mt-1 uppercase font-bold">${m.sub}</p></div>`).join('');
        }

        function renderCalendar(data) {
            const monthVal = document.getElementById('calendar-month-select').value;
            const [year, month0] = monthVal.split('-').map(Number);
            const month = month0 - 1;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startOffset = (firstDay === 0 ? 6 : firstDay - 1);
            const dailyPnL = {};
            data.forEach(t => {
                const d = new Date(t.date);
                if (d.getFullYear() === year && d.getMonth() === month) {
                    const day = d.getDate();
                    dailyPnL[day] = (dailyPnL[day] || 0) + t.profit;
                }
            });
            let html = '';
            for (let i = 0; i < startOffset; i++) html += '<div class="calendar-day opacity-0"></div>';
            for (let d = 1; d <= daysInMonth; d++) {
                const pnl = dailyPnL[d];
                let cls = 'day-empty', pnlLabel = '';
                if (pnl !== undefined) { cls = pnl >= 0 ? 'day-profit' : 'day-loss'; pnlLabel = `<span class="pnl-text">${pnl >= 0 ? '+' : ''}${Math.round(pnl)}</span>`; }
                html += `<div class="calendar-day ${cls}"><span class="opacity-50">${d}</span>${pnlLabel}</div>`;
            }
            document.getElementById('calendar-heatmap').innerHTML = html;
        }

        function renderTradeList(filteredData) {
            const search = document.getElementById('search-input').value.toUpperCase();
            const status = document.getElementById('filter-status').value;
            const list = filteredData.filter(t => {
                const matchSearch = t.pair.includes(search);
                const matchStatus = status === 'all' || (status === 'win' ? t.profit > 0 : t.profit <= 0);
                return matchSearch && matchStatus;
            });
            const body = document.getElementById('trade-list');
            const empty = document.getElementById('empty-state');
            document.getElementById('log-count').textContent = list.length;
            if (list.length === 0) { body.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            body.innerHTML = list.slice().reverse().map(t => `
                <tr class="trade-row border-b border-gray-800/20">
                    <td class="px-5 py-5 text-gray-500 font-mono text-[11px]">${new Date(t.date).toLocaleString()}</td>
                    <td class="px-5 py-5 font-black text-white text-base">${t.pair}</td>
                    <td class="px-5 py-5 text-right font-black text-base ${t.profit >= 0 ? 'text-[#10b981]' : 'text-[#ff4b5c]'}">${t.profit >= 0 ? '+' : ''}${t.profit.toFixed(2)}</td>
                    <td class="px-5 py-5 text-right text-indigo-400 font-bold text-base">${t.r}R</td>
                    <td class="px-5 py-5 text-center"><span class="px-3 py-1 rounded text-[10px] font-black uppercase ${t.direction === 'Long' ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/20' : 'bg-rose-500/20 text-rose-400 border border-rose-500/20'}">${t.direction}</span></td>
                    <td class="px-5 py-5 text-right flex items-center justify-end space-x-2">
                        <a href="https://www.tradingview.com/chart/?symbol=${t.pair.replace('/','')}" target="_blank" class="action-icon text-cyan-400 hover:text-cyan-300" title="TradingView å›¾è¡¨">
                            <i class="fas fa-chart-area"></i>
                        </a>
                        <button onclick="window.editTrade('${t.id}')" class="action-icon text-gray-400 hover:text-white" title="ç¼–è¾‘è®°å½•">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="window.deleteTrade('${t.id}')" class="action-icon text-gray-500 hover:text-rose-500" title="åˆ é™¤è®°å½•">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateChart(all, viewData) {
            const initial = config.initialCapital;
            let currentViewPnL = 0, baseEquity = initial;
            if (viewData.length > 0) {
                const firstDate = new Date(viewData[0].date);
                all.forEach(t => { if (new Date(t.date) < firstDate) baseEquity += t.profit; });
            }
            const pts = [];
            if (viewData.length > 0) {
                pts.push({ x: new Date(viewData[0].date), y: baseEquity });
                let running = baseEquity;
                viewData.forEach(t => { running += t.profit; currentViewPnL += t.profit; pts.push({ x: new Date(t.date), y: running }); });
            }
            document.getElementById('view-pnl').textContent = `${currentViewPnL >= 0 ? '+' : ''}$${currentViewPnL.toFixed(2)}`;
            document.getElementById('view-pnl').className = `text-lg font-black font-mono mt-1 ${currentViewPnL >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
            document.getElementById('view-count').textContent = viewData.length;
            const ctx = document.getElementById('equity-chart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { datasets: [{ 
                    data: pts, borderColor: '#00d4ff', borderWidth: 2, pointRadius: 3, fill: true,
                    backgroundColor: (c) => { const g = c.chart.ctx.createLinearGradient(0, 0, 0, 400); g.addColorStop(0, 'rgba(0, 212, 255, 0.15)'); g.addColorStop(1, 'rgba(0, 212, 255, 0)'); return g; },
                    tension: 0.1 
                }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }, scales: { x: { type: 'time', grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#4b5563', font: {size: 9} } }, y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#4b5563', font: {size: 9} } } } }
            });
        }

        window.changeMonth = (off) => {
            const el = document.getElementById('calendar-month-select');
            const [y, m] = el.value.split('-').map(Number);
            const date = new Date(y, m - 1 + off, 1);
            el.value = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
            viewMode = 'month'; refreshUI();
        };

        document.getElementById('btn-7d').onclick = () => { viewMode = '7d'; refreshUI(); };
        document.getElementById('btn-this-month').onclick = () => { viewMode = 'month'; refreshUI(); };
        document.getElementById('calendar-month-select').onchange = () => { viewMode = 'month'; refreshUI(); };
        document.getElementById('search-input').oninput = refreshUI;
        document.getElementById('filter-status').onchange = refreshUI;

        window.openModal = () => {
            document.getElementById('trade-form').reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('trade-date').value = new Date().toISOString().slice(0, 16);
            document.getElementById('trade-modal').classList.remove('hidden');
        };
        window.closeModal = () => document.getElementById('trade-modal').classList.add('hidden');
        document.getElementById('trade-form').onsubmit = async (e) => {
            e.preventDefault();
            const trade = { pair: document.getElementById('trade-pair').value.toUpperCase(), profit: parseFloat(document.getElementById('trade-profit').value), direction: document.getElementById('trade-direction').value, r: parseFloat(document.getElementById('trade-r').value), date: document.getElementById('trade-date').value };
            const eid = document.getElementById('edit-id').value;
            if (eid) await updateDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'trades', eid), trade);
            else await addDoc(collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'trades'), trade);
            window.closeModal();
        };
        window.deleteTrade = async (id) => { if(confirm("ç¡®å®šå½»åº•åˆ é™¤æ­¤äº¤æ˜“è®°å½•ï¼Ÿ")) await deleteDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'trades', id)); };
        window.editTrade = (id) => {
            const t = allTrades.find(x => x.id === id);
            document.getElementById('edit-id').value = t.id;
            document.getElementById('trade-pair').value = t.pair;
            document.getElementById('trade-profit').value = t.profit;
            document.getElementById('trade-direction').value = t.direction;
            document.getElementById('trade-r').value = t.r;
            document.getElementById('trade-date').value = t.date;
            document.getElementById('trade-modal').classList.remove('hidden');
        };
        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value); } catch (err) { alert("ç™»å½•å¤±è´¥: " + err.message); }
        };
        document.getElementById('btn-register').onclick = async () => {
            try { await createUserWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value); } catch (err) { alert("æ³¨å†Œå¤±è´¥: " + err.message); }
        };
        document.getElementById('btn-logout').onclick = () => signOut(auth);
    </script>
</body>
</html>














