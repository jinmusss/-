<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘æœ¨å¸¸èƒœæ—¥å¿— - èµ›åšäº¤æ˜“åˆ†æ</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Chart.js åŠå…¶æ—¥æœŸé€‚é…å™¨ç”¨äºå›¾è¡¨ç»˜åˆ¶ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        /* --- èµ›åšéœ“è™¹ä¸»é¢˜é¢œè‰²å®šä¹‰ --- */
        :root {
            --bg-main: #0d0d17; /* æ·±é»‘/ç´« */
            --bg-comp: #1a1a2e; /* ç¨äº®çš„æ·±ç´«/è“ï¼Œç”¨äºç»„ä»¶èƒŒæ™¯ */
            --neon-cyan: #22d3ee; /* cyan-400 */
            --neon-fuchsia: #e879f9; /* fuchsia-500 */
            --text-color: #e2e8f0;
        }

        /* å…¨å±€æ ·å¼ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 1rem;
            padding-bottom: 2rem;
        }

        /* ç»„ä»¶èƒŒæ™¯ */
        .component-bg {
            background-color: var(--bg-comp);
        }

        /* 1. éœ“è™¹å¡ç‰‡æ ·å¼ (neon-card) */
        .neon-card {
            transition: all 0.3s ease-in-out;
            box-shadow: 0 0 5px rgba(232, 121, 249, 0.2), 0 0 10px rgba(34, 211, 238, 0.2);
            border: 1px solid rgba(34, 211, 238, 0.1);
        }

        .neon-card:hover {
            box-shadow: 0 0 15px var(--neon-fuchsia), 0 0 25px var(--neon-cyan);
            transform: translateY(-3px);
            border-color: var(--neon-cyan);
            z-index: 5; /* æå‡å±‚çº§ï¼Œé˜²æ­¢è¢«é®æŒ¡ */
        }
        
        /* 2. éœ“è™¹è„‰å†²åŠ¨ç”» (animate-pulse-neon) */
        @keyframes pulse-neon {
            0%, 100% {
                box-shadow: 0 0 10px var(--neon-fuchsia), 0 0 20px var(--neon-cyan);
                filter: brightness(1);
            }
            50% {
                box-shadow: 0 0 20px var(--neon-fuchsia), 0 0 40px var(--neon-cyan);
                filter: brightness(1.2);
            }
        }

        .animate-pulse-neon {
            animation: pulse-neon 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* 6. å›¾è¡¨åŒºåŸŸå®¹å™¨æ ·å¼ */
        #chart-container {
            position: relative;
            /* æ·±è‰²æ¸å˜èƒŒæ™¯ */
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8), rgba(13, 13, 23, 0.9)); 
            border: 1px solid rgba(232, 121, 249, 0.3);
            min-height: 300px; /* ç¡®ä¿å ä½ç¬¦å¯è§ */
        }

        /* 6. æ•°æ®çŸ©é˜µå¾…æ¿€æ´» å ä½ç¬¦æ ·å¼ */
        .chart-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--neon-cyan);
            text-shadow: 0 0 5px var(--neon-cyan);
            font-size: 1.5rem;
            text-align: center;
            pointer-events: none;
            opacity: 0.7;
        }

        /* è¦†ç›– Chart.js å·¥å…·æç¤ºçš„é»˜è®¤ç™½è‰²èƒŒæ™¯ï¼Œä½¿å…¶èå…¥é»‘æš—ä¸»é¢˜ */
        .chartjs-tooltip {
            background: var(--bg-comp) !important;
            border: 1px solid var(--neon-cyan) !important;
            color: var(--text-color) !important;
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.5) !important;
        }
    </style>
    
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto w-full space-y-8">
        <!-- å¤´éƒ¨/æ ‡é¢˜åŒºåŸŸ -->
        <header class="text-center pb-4">
            <h1 class="text-4xl font-extrabold tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-fuchsia-500 shadow-lg">
                é‡‘æœ¨å¸¸èƒœæ—¥å¿— ğŸŒŒ
            </h1>
            <p class="text-sm text-gray-500 mt-1">èµ›åšäº¤æ˜“åˆ†æç»ˆç«¯ V2.0 è¿è¡Œä¸­</p>
        </header>

        <!-- åˆå§‹èµ„æœ¬è®¾ç½®/å›æµ‹å¯åŠ¨æŒ‰é’® -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
            <!-- åˆå§‹èµ„æœ¬å¡ç‰‡ (ä½¿ç”¨ neon-card æ ·å¼) -->
            <div id="capital-display" class="md:col-span-2 p-6 rounded-xl component-bg neon-card flex flex-col md:flex-row justify-between items-center space-y-3 md:space-y-0 md:space-x-4">
                <div class="text-lg font-bold">åˆå§‹å¯åŠ¨èµ„é‡‘: <span id="initial-capital-value" class="text-cyan-400">ï¿¥0.00</span></div>
                <button onclick="openTradeModal('capital-setup')" class="bg-fuchsia-500 hover:bg-fuchsia-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    <span class="text-sm">ğŸŒŒ é…ç½®åˆå§‹èµ„æœ¬</span>
                </button>
            </div>
            
            <!-- å¯åŠ¨å›æµ‹æŒ‰é’® (ä½¿ç”¨ animate-pulse-neon æ ·å¼) -->
            <button id="run-backtest-btn" class="w-full h-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 animate-pulse-neon text-lg uppercase" disabled>
                å¯åŠ¨å›æµ‹æ¨¡æ‹Ÿ âš¡
            </button>
        </div>

        <!-- 3. æŒ‡æ ‡å¡ç‰‡åŒºåŸŸ -->
        <section id="metrics-container" class="grid grid-cols-2 md:grid-cols-4 gap-4" aria-label="äº¤æ˜“æŒ‡æ ‡æ¦‚è§ˆ">
            <!-- Metrics will be rendered here by JavaScript -->
        </section>

        <!-- 4. å›¾è¡¨/å¯è§†åŒ–åŒºåŸŸ (ä½¿ç”¨ neon-card æ ·å¼) -->
        <section class="p-6 rounded-xl component-bg neon-card shadow-lg" aria-label="ç›ˆäºæ›²çº¿å›¾">
            <h2 class="text-xl font-bold mb-4 text-cyan-400 border-b border-cyan-400/20 pb-2">æ•°æ®çŸ©é˜µ: ç›ˆäºæ›²çº¿</h2>
            <div id="chart-controls" class="flex flex-wrap gap-4 mb-4 text-sm">
                 <button data-filter="all" class="chart-filter-btn text-fuchsia-500 border border-fuchsia-500/50 hover:bg-fuchsia-900 px-3 py-1 rounded-full transition duration-150">æ‰€æœ‰è®°å½•</button>
                 <button data-filter="last-30" class="chart-filter-btn text-gray-400 border border-gray-600 hover:bg-gray-800 px-3 py-1 rounded-full transition duration-150">è¿‘ 30 å¤©</button>
                 <button data-filter="year-to-date" class="chart-filter-btn text-gray-400 border border-gray-600 hover:bg-gray-800 px-3 py-1 rounded-full transition duration-150">ä»Šå¹´è‡³ä»Š</button>
            </div>

            <!-- Chart Canvas Container -->
            <div id="chart-container" class="rounded-lg overflow-hidden relative">
                <!-- 6. æ•°æ®çŸ©é˜µå¾…æ¿€æ´» å ä½ç¬¦ -->
                <div class="chart-placeholder">
                    <div class="text-4xl mb-2">ğŸ‘¾</div>
                    æ•°æ®çŸ©é˜µå¾…æ¿€æ´»: æ­£åœ¨ç­‰å¾…äº¤æ˜“æ•°æ®åŠ è½½...
                </div>
                <canvas id="profitChart" class="w-full h-full"></canvas>
            </div>
        </section>

        <!-- äº¤æ˜“æ—¥å¿—/è¡¨æ ¼åŒºåŸŸ (ä½¿ç”¨ neon-card æ ·å¼) -->
        <section class="p-6 rounded-xl component-bg neon-card shadow-lg" aria-label="äº¤æ˜“è®°å½•æ—¥å¿—">
            <div class="flex justify-between items-center mb-4 border-b border-fuchsia-500/20 pb-2">
                <h2 class="text-xl font-bold text-fuchsia-500">äº¤æ˜“è®°å½•æ—¥å¿—</h2>
                <button onclick="openTradeModal('trade-entry')" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition duration-200">
                    <span class="text-sm">âŠ• è®°å½•æ–°äº¤æ˜“</span>
                </button>
            </div>
            
            <!-- äº¤æ˜“æ—¥å¿—è¿‡æ»¤å™¨ -->
            <div id="log-filters" class="flex flex-wrap gap-4 mb-4 text-sm">
                <select id="log-filter-result" class="p-2 rounded component-bg border border-gray-700 text-gray-300">
                    <option value="all">æ‰€æœ‰ç»“æœ</option>
                    <option value="win">ç›ˆåˆ© (WIN)</option>
                    <option value="loss">äºæŸ (LOSS)</option>
                </select>
                <input type="text" id="log-filter-symbol" placeholder="æŒ‰èµ„äº§ä»£ç è¿‡æ»¤ (å¦‚: BTC)" class="p-2 rounded component-bg border border-gray-700 text-gray-300 placeholder-gray-500">
                <button onclick="applyLogFilter()" class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-1 rounded transition duration-150">åº”ç”¨ç­›é€‰</button>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead>
                        <tr class="uppercase text-xs tracking-wider text-gray-400 bg-gray-900/50">
                            <th class="px-4 py-3 text-left">æ—¥æœŸ</th>
                            <th class="px-4 py-3 text-left">ä»£ç </th>
                            <th class="px-4 py-3 text-left">æ–¹å‘</th>
                            <th class="px-4 py-3 text-right">ç›ˆäºé¢ (Â¥)</th>
                            <th class="px-4 py-3 text-center">ç»“æœ</th>
                            <th class="px-4 py-3 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="trade-log-body" class="divide-y divide-gray-800">
                        <!-- Trade logs will be inserted here -->
                        <tr class="text-gray-500"><td colspan="6" class="p-4 text-center">æ­£åœ¨åŠ è½½æ•°æ®æ ¸å¿ƒ...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>


    <!-- æ¨¡æ€æ¡†: äº¤æ˜“å½•å…¥/èµ„æœ¬é…ç½® (ä½¿ç”¨ neon-card æ ·å¼) -->
    <div id="trade-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div id="trade-modal-content" class="w-full max-w-lg p-6 rounded-xl component-bg neon-card shadow-2xl space-y-6">
            <h3 id="trade-modal-title" class="text-2xl font-bold border-b border-fuchsia-500/50 pb-2 text-fuchsia-500">è®°å½•æ–°äº¤æ˜“</h3>
            <form id="trade-form" class="space-y-4">
                <div id="trade-form-fields">
                    <!-- äº¤æ˜“å½•å…¥å­—æ®µ -->
                    <div>
                        <label for="trade-date" class="block text-sm font-medium text-gray-300">æ—¥æœŸ</label>
                        <input type="date" id="trade-date" name="date" required class="mt-1 block w-full p-2 rounded component-bg border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="trade-symbol" class="block text-sm font-medium text-gray-300">èµ„äº§ä»£ç  (å¦‚: BTC, NASDAQ)</label>
                        <input type="text" id="trade-symbol" name="symbol" placeholder="è¾“å…¥ä»£ç " required class="mt-1 block w-full p-2 rounded component-bg border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="trade-direction" class="block text-sm font-medium text-gray-300">æ–¹å‘</label>
                        <select id="trade-direction" name="direction" required class="mt-1 block w-full p-2 rounded component-bg border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500">
                            <option value="Long">åšå¤š (Long)</option>
                            <option value="Short">åšç©º (Short)</option>
                        </select>
                    </div>
                    <div>
                        <label for="trade-pnl" class="block text-sm font-medium text-gray-300">ç›ˆäºé‡‘é¢ (Â¥)</label>
                        <input type="number" id="trade-pnl" name="pnl" placeholder="è¾“å…¥ç›ˆåˆ©æˆ–äºæŸé‡‘é¢" required step="0.01" class="mt-1 block w-full p-2 rounded component-bg border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="trade-notes" class="block text-sm font-medium text-gray-300">å¤‡æ³¨/å¿ƒå¾—</label>
                        <textarea id="trade-notes" name="notes" rows="3" class="mt-1 block w-full p-2 rounded component-bg border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500"></textarea>
                    </div>
                </div>
                
                <!-- èµ„æœ¬é…ç½®å­—æ®µ (åˆå§‹éšè—) -->
                <div id="capital-setup-fields" class="hidden">
                    <div>
                        <label for="initial-capital" class="block text-sm font-medium text-gray-300">åˆå§‹å¯åŠ¨èµ„é‡‘ (Â¥)</label>
                        <input type="number" id="initial-capital" name="capital" placeholder="è¾“å…¥åˆå§‹èµ„é‡‘é¢" required min="0" class="mt-1 block w-full p-2 rounded component-bg border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeTradeModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" id="modal-submit-btn" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition duration-200">
                        ç¡®è®¤å½•å…¥
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- æ¨¡æ€æ¡†: äº¤æ˜“è¯¦æƒ… (ä½¿ç”¨ neon-card æ ·å¼) -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="w-full max-w-lg p-6 rounded-xl component-bg neon-card shadow-2xl space-y-4">
            <h3 class="text-2xl font-bold border-b border-cyan-400/50 pb-2 text-cyan-400">äº¤æ˜“æ•°æ®è¯¦æƒ…</h3>
            <div id="detail-content" class="space-y-3">
                <!-- Details will be loaded here -->
            </div>
            <div class="flex justify-end space-x-4">
                 <button onclick="openEditModal(window.currentDetailTradeId)" class="bg-fuchsia-500 hover:bg-fuchsia-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    ç¼–è¾‘
                </button>
                <button onclick="closeDetailModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ¨¡æ€æ¡†: ç¼–è¾‘äº¤æ˜“ (ä½¿ç”¨ neon-card æ ·å¼) -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="w-full max-w-lg p-6 rounded-xl component-bg neon-card shadow-2xl space-y-6">
            <h3 class="text-2xl font-bold border-b border-fuchsia-500/50 pb-2 text-fuchsia-500">ç¼–è¾‘äº¤æ˜“è®°å½•</h3>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-trade-id">
                <!-- äº¤æ˜“å½•å…¥å­—æ®µ (ç”¨äºç¼–è¾‘) -->
                <div>
                    <label for="edit-trade-date" class="block text-sm font-medium text-gray-300">æ—¥æœŸ</label>
                    <input type="date" id="edit-trade-date" name="date" required class="mt-1 block w-full p-2 rounded component-bg border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                <div>
                    <label for="edit-trade-symbol" class="block text-sm font-medium text-gray-300">èµ„äº§ä»£ç </label>
                    <input type="text" id="edit-trade-symbol" name="symbol" required class="mt-1 block w-full p-2 rounded component-bg border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                <div>
                    <label for="edit-trade-direction" class="block text-sm font-medium text-gray-300">æ–¹å‘</label>
                    <select id="edit-trade-direction" name="direction" required class="mt-1 block w-full p-2 rounded component-bg border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500">
                        <option value="Long">åšå¤š (Long)</option>
                        <option value="Short">åšç©º (Short)</option>
                    </select>
                </div>
                <div>
                    <label for="edit-trade-pnl" class="block text-sm font-medium text-gray-300">ç›ˆäºé‡‘é¢ (Â¥)</label>
                    <input type="number" id="edit-trade-pnl" name="pnl" required step="0.01" class="mt-1 block w-full p-2 rounded component-bg border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                <div>
                    <label for="edit-trade-notes" class="block text-sm font-medium text-gray-300">å¤‡æ³¨/å¿ƒå¾—</label>
                    <textarea id="edit-trade-notes" name="notes" rows="3" class="mt-1 block w-full p-2 rounded component-bg border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500"></textarea>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeEditModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition duration-200">
                        ä¿å­˜æ›´æ”¹
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- æ¨¡æ€æ¡†: ç¡®è®¤åˆ é™¤ (ä½¿ç”¨ neon-card æ ·å¼) -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="w-full max-w-sm p-6 rounded-xl component-bg neon-card space-y-4">
            <h3 class="text-xl font-bold text-fuchsia-500">ç¡®è®¤åˆ é™¤</h3>
            <p class="text-gray-300">æ‚¨ç¡®å®šè¦åˆ é™¤è¿™æ¡äº¤æ˜“è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            <div class="flex justify-end space-x-4">
                <button onclick="closeConfirmDeleteModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    å–æ¶ˆ
                </button>
                <button id="execute-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    ç¡®è®¤åˆ é™¤
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Firebase å¯¼å…¥ ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º Debugï¼Œä»¥ä¾¿åœ¨æ§åˆ¶å°æŸ¥çœ‹ Firestore æ“ä½œ
        setLogLevel('Debug');

        // --- å…¨å±€å˜é‡ ---
        let app, db, auth;
        let userId = null;
        let allTrades = []; // å­˜å‚¨æ‰€æœ‰äº¤æ˜“æ•°æ®
        let tradesByDate = {}; // å­˜å‚¨æŒ‰æ—¥æœŸåˆ†ç»„çš„äº¤æ˜“æ•°æ®
        let profitChart;
        let initialCapital = 0; // åˆå§‹èµ„æœ¬
        let logFilter = { result: 'all', symbol: '' };
        
        // ç¡®ä¿ __app_id å’Œ __firebase_config å¯ç”¨
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const tradeForm = document.getElementById('trade-form');
        const editForm = document.getElementById('edit-form');
        const chartPlaceholder = document.querySelector('.chart-placeholder');


        // --- å·¥å…·å‡½æ•°: Lucide SVG å›¾æ ‡ç”Ÿæˆ ---
        const getIconSvg = (name, className = 'w-6 h-6') => {
            switch (name) {
                case 'flash':
                    // Lucide Flash (Lightning Bolt)
                    return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><path d="M13 2H3l8 11h-4l6 9V11h5L13 2z"/></svg>`;
                case 'target':
                    // Lucide Target (Bullseye)
                    return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`;
                case 'trending-up':
                    // Lucide Trending Up (Trend Line)
                    return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>`;
                case 'data':
                    // Lucide Database (Data Line/Chip)
                    return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>`;
                default:
                    return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`;
            }
        };


        // --- Firebase åˆå§‹åŒ–ä¸èº«ä»½éªŒè¯ ---
        const firebaseInit = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase é…ç½®ç¼ºå¤±ã€‚æ— æ³•åˆå§‹åŒ– Firebaseã€‚");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // èº«ä»½éªŒè¯é€»è¾‘ï¼šä½¿ç”¨è‡ªå®šä¹‰ token æˆ–åŒ¿åç™»å½•
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }

                // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // è®¤è¯å®Œæˆåï¼Œå¼€å§‹ç›‘å¬æ•°æ®
                        listenForCapitalUpdate();
                        listenForTrades();
                        document.getElementById('run-backtest-btn').disabled = false; // å…è®¸å¯åŠ¨å›æµ‹
                    } else {
                        console.log("ç”¨æˆ·å·²ç™»å‡ºæˆ–è®¤è¯å¤±è´¥ã€‚");
                        userId = null;
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–æˆ–è®¤è¯å¤±è´¥:", error);
            }
        };

        // --- Firestore è·¯å¾„ç”Ÿæˆå·¥å…· ---
        const getPrivateDocRef = (collectionName, docId) => {
            if (!userId) return null;
            return doc(db, 'artifacts', appId, 'users', userId, collectionName, docId);
        };
        const getPrivateCollectionRef = (collectionName) => {
            if (!userId) return null;
            return collection(db, 'artifacts', appId, 'users', userId, collectionName);
        };

        // --- èµ„æœ¬ç®¡ç† ---
        const CAPITAL_DOC_ID = 'initial_capital';
        
        const saveInitialCapital = async (capital) => {
            if (!userId) return console.error("ç”¨æˆ·IDä¸å¯ç”¨ã€‚");
            const capitalRef = getPrivateDocRef('settings', CAPITAL_DOC_ID);
            
            try {
                await setDoc(capitalRef, { value: capital, lastUpdated: new Date() }, { merge: true });
                initialCapital = capital;
                document.getElementById('initial-capital-value').textContent = formatCurrency(initialCapital);
                closeTradeModal(); // å…³é—­æ¨¡æ€æ¡†
            } catch (error) {
                console.error("ä¿å­˜åˆå§‹èµ„æœ¬å¤±è´¥:", error);
            }
        };
        
        const listenForCapitalUpdate = () => {
             if (!userId) return;
             const capitalRef = getPrivateDocRef('settings', CAPITAL_DOC_ID);
             onSnapshot(capitalRef, (docSnap) => {
                 if (docSnap.exists()) {
                     const data = docSnap.data();
                     initialCapital = data.value || 0;
                     document.getElementById('initial-capital-value').textContent = formatCurrency(initialCapital);
                     renderMetrics(); // èµ„æœ¬æ›´æ–°åé‡æ–°æ¸²æŸ“æŒ‡æ ‡
                     updateChart(); // èµ„æœ¬æ›´æ–°åé‡æ–°ç»˜åˆ¶å›¾è¡¨
                 } else {
                     initialCapital = 0;
                     document.getElementById('initial-capital-value').textContent = formatCurrency(initialCapital);
                     renderMetrics();
                     updateChart();
                 }
             }, (error) => {
                 console.error("ç›‘å¬åˆå§‹èµ„æœ¬å¤±è´¥:", error);
             });
        };

        // --- äº¤æ˜“æ•°æ®ç›‘å¬ ---
        const listenForTrades = () => {
            if (!userId) return;
            const tradesColRef = getPrivateCollectionRef('trades');
            // æ³¨æ„ï¼šFirestore ä¸æ”¯æŒåœ¨å•ä¸ªæŸ¥è¯¢ä¸­æŒ‰ä¸åŒå­—æ®µæ’åºã€‚
            // æˆ‘ä»¬å°†è·å–æ‰€æœ‰æ•°æ®å¹¶åœ¨å®¢æˆ·ç«¯è¿›è¡Œæ’åºã€‚
            const q = query(tradesColRef);

            onSnapshot(q, (snapshot) => {
                allTrades = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date instanceof Date ? doc.data().date : (doc.data().date?.toDate() || new Date(doc.data().date)), // ç¡®ä¿æ˜¯ Date å¯¹è±¡
                    pnl: parseFloat(doc.data().pnl) || 0,
                }));
                
                // æŒ‰æ—¥æœŸæ’åº (æœ€æ–°åœ¨å‰)
                allTrades.sort((a, b) => b.date.getTime() - a.date.getTime());
                
                processTradesData();
                renderLogTable();
                renderMetrics();
                updateChart();
            }, (error) => {
                console.error("ç›‘å¬äº¤æ˜“æ•°æ®å¤±è´¥:", error);
                document.getElementById('trade-log-body').innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">æ•°æ®åŒæ­¥å¤±è´¥ï¼š${error.message}</td></tr>`;
            });
        };

        // --- æ•°æ®å¤„ç† ---
        const processTradesData = () => {
            tradesByDate = {};
            // ç¡®ä¿äº¤æ˜“æŒ‰æ—¶é—´é¡ºåºå¤„ç† (æœ€æ—§åœ¨å‰)
            const sortedTrades = [...allTrades].sort((a, b) => a.date.getTime() - b.date.getTime());

            let cumulativePnL = initialCapital;

            sortedTrades.forEach(trade => {
                // è®¡ç®—ç´¯è®¡ç›ˆäº
                cumulativePnL += trade.pnl;
                trade.cumulativePnL = cumulativePnL; 

                // æŒ‰æ—¥æœŸåˆ†ç»„
                const dateStr = trade.date.toISOString().split('T')[0];
                if (!tradesByDate[dateStr]) {
                    tradesByDate[dateStr] = [];
                }
                tradesByDate[dateStr].push(trade);
            });
        };
        
        // --- æ ¼å¼åŒ–å·¥å…· ---
        const formatCurrency = (amount) => {
            const formatter = new Intl.NumberFormat('zh-CN', {
                style: 'currency',
                currency: 'CNY',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
            });
            return formatter.format(amount);
        };

        // --- æŒ‡æ ‡è®¡ç®—ä¸æ¸²æŸ“ (Metric Cards) ---
        const calculateMetrics = () => {
            const totalTrades = allTrades.length;
            const totalWins = allTrades.filter(t => t.pnl > 0).length;
            const totalLosses = allTrades.filter(t => t.pnl < 0).length;
            const totalPnL = allTrades.reduce((sum, t) => sum + t.pnl, 0);
            
            const winRate = totalTrades > 0 ? ((totalWins / totalTrades) * 100).toFixed(1) + '%' : '0.0%';
            const totalPnLFormatted = formatCurrency(totalPnL);
            const initialCapitalFormatted = formatCurrency(initialCapital);
            
            return { totalTrades, winRate, totalPnL, totalPnLFormatted, initialCapitalFormatted };
        };

        const renderMetrics = () => {
            const { totalTrades, winRate, totalPnL, totalPnLFormatted, initialCapitalFormatted } = calculateMetrics();

            // 3. å®šä¹‰æ–°çš„æŒ‡æ ‡æ•°æ®ç»“æ„ï¼Œä½¿ç”¨ Lucide-style icons å’Œ neon colors
            const metricData = [
                { 
                    label: 'æ€»äº¤æ˜“æ¬¡æ•°', 
                    value: totalTrades, 
                    icon: 'flash', 
                    borderColor: 'var(--neon-cyan)', 
                    textColor: 'text-cyan-400',
                    bgColor: 'bg-cyan-900/50'
                },
                { 
                    label: 'èƒœç‡ (ğŸ¯)', 
                    value: winRate, 
                    icon: 'target', 
                    borderColor: 'var(--neon-fuchsia)', 
                    textColor: 'text-fuchsia-400',
                    bgColor: 'bg-fuchsia-900/50'
                },
                { 
                    label: 'æ€»ç›ˆäº (P&L)', 
                    value: totalPnLFormatted, 
                    icon: 'trending-up', 
                    // PnL é¢œè‰²åŠ¨æ€å˜åŒ–
                    borderColor: totalPnL >= 0 ? 'var(--neon-cyan)' : '#ef4444', 
                    textColor: totalPnL >= 0 ? 'text-cyan-400' : 'text-red-500',
                    bgColor: totalPnL >= 0 ? 'bg-cyan-900/50' : 'bg-red-900/50'
                },
                { 
                    label: 'åˆå§‹èµ„æœ¬ (â‚¿)', 
                    value: initialCapitalFormatted, 
                    icon: 'data', 
                    borderColor: '#94a3b8', 
                    textColor: 'text-gray-400',
                    bgColor: 'bg-gray-700/50'
                },
            ];

            const container = document.getElementById('metrics-container');
            
            // æ¸²æŸ“ä¸ºæ•°æ®èŠ¯ç‰‡é£æ ¼
            container.innerHTML = metricData.map(m => `
                <div class="p-4 rounded-xl component-bg shadow-xl neon-card transition-all duration-300 transform hover:scale-[1.02]" 
                     style="border: 1px solid ${m.borderColor};">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 rounded-full ${m.bgColor}" style="color: ${m.borderColor};">
                            ${getIconSvg(m.icon, 'w-6 h-6')}
                        </div>
                        <div class="flex-1">
                            <div class="text-xs uppercase text-gray-400">${m.label}</div>
                            <div class="text-2xl font-extrabold ${m.textColor}">${m.value}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        };
        
        // --- äº¤æ˜“æ—¥å¿—è¡¨æ ¼æ¸²æŸ“ ---
        const renderLogTable = () => {
            const tableBody = document.getElementById('trade-log-body');
            
            // ç­›é€‰æ•°æ®
            let filteredTrades = allTrades.filter(trade => {
                const resultMatch = logFilter.result === 'all' || 
                                    (logFilter.result === 'win' && trade.pnl > 0) ||
                                    (logFilter.result === 'loss' && trade.pnl < 0);
                
                const symbolMatch = logFilter.symbol === '' || 
                                    trade.symbol.toLowerCase().includes(logFilter.symbol.toLowerCase());
                
                return resultMatch && symbolMatch;
            });
            
            if (filteredTrades.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">æœªæ‰¾åˆ°åŒ¹é…çš„äº¤æ˜“è®°å½•ã€‚</td></tr>`;
                return;
            }

            tableBody.innerHTML = filteredTrades.map(trade => {
                const resultText = trade.pnl > 0 ? 'WIN' : (trade.pnl < 0 ? 'LOSS' : 'FLAT');
                const resultClass = trade.pnl > 0 ? 'bg-green-700/50 text-green-300' : (trade.pnl < 0 ? 'bg-red-700/50 text-red-300' : 'bg-gray-700/50 text-gray-400');
                const pnlClass = trade.pnl >= 0 ? 'text-cyan-400' : 'text-red-500';
                
                return `
                    <tr class="hover:bg-gray-800/50 transition duration-150">
                        <td class="px-4 py-3 text-sm">${trade.date.toISOString().split('T')[0]}</td>
                        <td class="px-4 py-3 text-sm font-medium">${trade.symbol}</td>
                        <td class="px-4 py-3 text-sm">${trade.direction}</td>
                        <td class="px-4 py-3 text-right text-sm font-mono ${pnlClass}">${formatCurrency(trade.pnl)}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${resultClass}">${resultText}</span>
                        </td>
                        <td class="px-4 py-3 text-center text-sm space-x-2">
                            <button onclick="openDetailModal('${trade.id}')" class="text-fuchsia-400 hover:text-fuchsia-300">è¯¦æƒ…</button>
                            <button onclick="openConfirmDeleteModal('${trade.id}')" class="text-red-500 hover:text-red-400">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
        };
        
        // --- äº¤æ˜“æ—¥å¿—ç­›é€‰ ---
        window.applyLogFilter = () => {
            logFilter.result = document.getElementById('log-filter-result').value;
            logFilter.symbol = document.getElementById('log-filter-symbol').value.trim();
            renderLogTable();
        };

        // --- CRUD æ“ä½œå‡½æ•° ---
        const saveTrade = async (event) => {
            event.preventDefault();
            if (!userId) return console.error("ç”¨æˆ·IDä¸å¯ç”¨ã€‚");
            
            const formData = new FormData(event.target);
            const newTrade = {
                date: new Date(formData.get('date')),
                symbol: formData.get('symbol').toUpperCase(),
                direction: formData.get('direction'),
                pnl: parseFloat(formData.get('pnl')),
                notes: formData.get('notes') || '',
            };
            
            try {
                const tradesColRef = getPrivateCollectionRef('trades');
                await addDoc(tradesColRef, newTrade);
                closeTradeModal();
                event.target.reset(); // æ¸…ç©ºè¡¨å•
            } catch (error) {
                console.error("ä¿å­˜äº¤æ˜“å¤±è´¥:", error);
            }
        };

        const updateTrade = async (event) => {
            event.preventDefault();
            if (!userId) return console.error("ç”¨æˆ·IDä¸å¯ç”¨ã€‚");
            
            const tradeId = document.getElementById('edit-trade-id').value;
            const formData = new FormData(event.target);
            
            const updatedData = {
                date: new Date(formData.get('date')),
                symbol: formData.get('symbol').toUpperCase(),
                direction: formData.get('direction'),
                pnl: parseFloat(formData.get('pnl')),
                notes: formData.get('notes') || '',
            };

            try {
                const tradeRef = getPrivateDocRef('trades', tradeId);
                await updateDoc(tradeRef, updatedData);
                closeEditModal();
            } catch (error) {
                console.error("æ›´æ–°äº¤æ˜“å¤±è´¥:", error);
            }
        };

        const deleteTrade = async (tradeId) => {
            if (!userId) return console.error("ç”¨æˆ·IDä¸å¯ç”¨ã€‚");
            try {
                const tradeRef = getPrivateDocRef('trades', tradeId);
                await deleteDoc(tradeRef);
                closeConfirmDeleteModal();
            } catch (error) {
                console.error("åˆ é™¤äº¤æ˜“å¤±è´¥:", error);
            }
        };

        // --- æ¨¡æ€æ¡†æ§åˆ¶ ---
        const tradeModal = document.getElementById('trade-modal');
        const detailModal = document.getElementById('detail-modal');
        const editModal = document.getElementById('edit-modal');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');

        const openTradeModal = (mode = 'trade-entry') => {
            const isCapital = mode === 'capital-setup';
            document.getElementById('trade-form-fields').classList.toggle('hidden', isCapital);
            document.getElementById('capital-setup-fields').classList.toggle('hidden', !isCapital);
            
            document.getElementById('trade-modal-title').textContent = isCapital ? 'é…ç½®åˆå§‹å¯åŠ¨èµ„é‡‘' : 'è®°å½•æ–°äº¤æ˜“';
            document.getElementById('modal-submit-btn').textContent = isCapital ? 'ç¡®è®¤è®¾ç½®' : 'ç¡®è®¤å½•å…¥';

            // æ›´æ”¹è¡¨å•æäº¤äº‹ä»¶ä»¥é€‚åº”æ¨¡å¼
            if (isCapital) {
                tradeForm.onsubmit = (e) => {
                    e.preventDefault();
                    const capital = parseFloat(document.getElementById('initial-capital').value);
                    if (!isNaN(capital)) saveInitialCapital(capital);
                };
                document.getElementById('initial-capital').value = initialCapital > 0 ? initialCapital : '';
            } else {
                tradeForm.onsubmit = saveTrade;
                // ç¡®ä¿æ—¥æœŸå­—æ®µæœ‰é»˜è®¤å€¼
                document.getElementById('trade-date').value = new Date().toISOString().split('T')[0];
            }
            
            tradeModal.classList.replace('hidden', 'flex');
        };

        const closeTradeModal = () => {
            tradeModal.classList.replace('flex', 'hidden');
        };

        const openDetailModal = (tradeId) => {
            window.currentDetailTradeId = tradeId; // Store ID for edit button
            const trade = allTrades.find(t => t.id === tradeId);
            if (!trade) return;

            const detailContent = document.getElementById('detail-content');
            const resultText = trade.pnl > 0 ? 'ç›ˆåˆ© (WIN) ğŸ‰' : (trade.pnl < 0 ? 'äºæŸ (LOSS) ğŸ“‰' : 'æŒå¹³ (FLAT) ğŸ˜');
            const pnlClass = trade.pnl >= 0 ? 'text-cyan-400' : 'text-red-500';

            detailContent.innerHTML = `
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="text-gray-400">æ—¥æœŸ:</div><div class="font-medium">${trade.date.toISOString().split('T')[0]}</div>
                    <div class="text-gray-400">èµ„äº§ä»£ç :</div><div class="font-medium">${trade.symbol}</div>
                    <div class="text-gray-400">æ–¹å‘:</div><div class="font-medium">${trade.direction}</div>
                    <div class="text-gray-400">ç»“æœ:</div><div class="font-medium">${resultText}</div>
                    <div class="text-gray-400">ç›ˆäºé‡‘é¢ (Â¥):</div><div class="font-extrabold ${pnlClass}">${formatCurrency(trade.pnl)}</div>
                </div>
                <div class="border-t border-gray-700 pt-3 mt-3">
                    <div class="text-gray-400 text-sm mb-1">å¤‡æ³¨/å¿ƒå¾—:</div>
                    <div class="p-3 rounded component-bg border border-gray-700 whitespace-pre-wrap text-sm">${trade.notes || 'æ— '}</div>
                </div>
            `;
            detailModal.classList.replace('hidden', 'flex');
        };

        const closeDetailModal = () => {
            detailModal.classList.replace('flex', 'hidden');
        };
        
        const openEditModal = (tradeId) => {
            closeDetailModal(); // Close detail modal first if open
            const trade = allTrades.find(t => t.id === tradeId);
            if (!trade) return;

            document.getElementById('edit-trade-id').value = trade.id;
            document.getElementById('edit-trade-date').value = trade.date.toISOString().split('T')[0];
            document.getElementById('edit-trade-symbol').value = trade.symbol;
            document.getElementById('edit-trade-direction').value = trade.direction;
            document.getElementById('edit-trade-pnl').value = trade.pnl;
            document.getElementById('edit-trade-notes').value = trade.notes;

            editModal.classList.replace('hidden', 'flex');
        };

        const closeEditModal = () => {
            editModal.classList.replace('flex', 'hidden');
        };
        
        const openConfirmDeleteModal = (tradeId) => {
            closeDetailModal(); // Close detail modal first if open
            document.getElementById('execute-delete-btn').onclick = () => deleteTrade(tradeId);
            confirmDeleteModal.classList.replace('hidden', 'flex');
        };

        const closeConfirmDeleteModal = () => {
            confirmDeleteModal.classList.replace('flex', 'hidden');
        };


        // --- å›¾è¡¨æ¸²æŸ“ä¸æ›´æ–° (Chart.js) ---
        const setupChart = () => {
            const ctx = document.getElementById('profitChart').getContext('2d');
            
            // Neon Gradient for Chart Fill
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(34, 211, 238, 0.5)'); // cyan-400
            gradient.addColorStop(1, 'rgba(13, 13, 23, 0.1)'); // near-black

            profitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // Dates
                    datasets: [{
                        label: 'ç´¯è®¡ç›ˆäºæ›²çº¿ (Â¥)',
                        data: [], // Cumulative PnL values
                        borderColor: 'var(--neon-fuchsia)', // éœ“è™¹ç´«çº¢è‰²çº¿æ¡
                        backgroundColor: gradient, // éœ“è™¹æ¸å˜å¡«å……
                        tension: 0.4, // æ›²çº¿å¹³æ»‘
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: 'var(--neon-cyan)',
                        pointBorderColor: 'var(--bg-main)',
                        pointHoverRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuad'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'yyyy/MM/dd',
                                displayFormats: { day: 'MM/dd' }
                            },
                            ticks: { color: 'gray' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }, // æ›´æš—çš„ç½‘æ ¼çº¿
                            title: { display: true, text: 'æ—¥æœŸ', color: 'gray' }
                        },
                        y: {
                            ticks: { color: 'gray', callback: formatCurrency },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            title: { display: true, text: 'ç´¯è®¡é‡‘é¢ (Â¥)', color: 'gray' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: 'var(--neon-cyan)' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        };
        
        const updateChart = (filterKey = 'all') => {
            if (!profitChart) return;

            // éšè—æˆ–æ˜¾ç¤ºå ä½ç¬¦
            if (allTrades.length === 0) {
                chartPlaceholder.classList.remove('hidden');
                profitChart.data.labels = [];
                profitChart.data.datasets[0].data = [];
                profitChart.update();
                return;
            } else {
                chartPlaceholder.classList.add('hidden');
            }
            
            const now = new Date();
            let startDate = new Date(0); // é»˜è®¤ä»å¤´å¼€å§‹

            if (filterKey === 'last-30') {
                startDate = new Date(now.setDate(now.getDate() - 30));
            } else if (filterKey === 'year-to-date') {
                startDate = new Date(now.getFullYear(), 0, 1);
            }
            
            // ç¡®ä¿äº¤æ˜“æŒ‰æ—¶é—´é¡ºåºå¤„ç† (æœ€æ—§åœ¨å‰)
            const sortedTrades = [...allTrades].sort((a, b) => a.date.getTime() - b.date.getTime());

            // è¿‡æ»¤å’Œå‡†å¤‡æ•°æ®
            let chartLabels = [];
            let chartData = [];
            let lastCapital = initialCapital;
            
            // æ‰¾åˆ°è¿‡æ»¤èµ·å§‹æ—¥æœŸå‰çš„æœ€åä¸€ä¸ªç´¯è®¡èµ„æœ¬å€¼
            const tradesBeforeStart = sortedTrades.filter(t => t.date < startDate);
            if (tradesBeforeStart.length > 0) {
                 lastCapital = tradesBeforeStart[tradesBeforeStart.length - 1].cumulativePnL;
            }

            // æ·»åŠ åˆå§‹èµ„æœ¬ç‚¹ï¼ˆå¦‚æœè¿‡æ»¤äº†æ—¥æœŸï¼‰
            if (filterKey !== 'all') {
                chartLabels.push(startDate.toISOString().split('T')[0]);
                chartData.push(lastCapital);
            }
            
            // ç´¯ç§¯è®¡ç®—ä»è¿‡æ»¤æ—¥æœŸå¼€å§‹
            let cumulativePnL = lastCapital;

            sortedTrades.forEach(trade => {
                if (trade.date >= startDate) {
                    // ç¡®ä¿æ¯å¤©åªè®°å½•ä¸€ä¸ªæœ€ç»ˆç´¯è®¡å€¼ï¼Œé¿å…å›¾è¡¨è¿‡äºå¯†é›†
                    const dateStr = trade.date.toISOString().split('T')[0];
                    cumulativePnL = trade.cumulativePnL; // ä½¿ç”¨å·²ç»è®¡ç®—å¥½çš„ç´¯è®¡å€¼
                    
                    if (chartLabels[chartLabels.length - 1] !== dateStr) {
                         chartLabels.push(dateStr);
                         chartData.push(cumulativePnL);
                    } else {
                         // è¦†ç›–å½“å¤©æœ€åä¸€ä¸ªå€¼
                         chartData[chartData.length - 1] = cumulativePnL;
                    }
                }
            });

            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä¸”æœ‰åˆå§‹èµ„æœ¬ï¼Œåˆ™åªæ˜¾ç¤ºä¸€ä¸ªç‚¹
            if (chartLabels.length === 0 && initialCapital > 0) {
                chartLabels.push(new Date().toISOString().split('T')[0]);
                chartData.push(initialCapital);
            }
            
            profitChart.data.labels = chartLabels;
            profitChart.data.datasets[0].data = chartData;
            profitChart.update();
        };
        
        const setupChartFilters = () => {
            const btns = document.querySelectorAll('.chart-filter-btn');
            btns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // æ›´æ–°æŒ‰é’®æ¿€æ´»çŠ¶æ€çš„éœ“è™¹æ•ˆæœ
                    btns.forEach(b => {
                        b.classList.remove('bg-fuchsia-900', 'text-fuchsia-500', 'border-fuchsia-500/50');
                        b.classList.add('text-gray-400', 'border-gray-600', 'hover:bg-gray-800');
                    });
                    this.classList.add('bg-fuchsia-900', 'text-fuchsia-500', 'border-fuchsia-500/50');
                    this.classList.remove('text-gray-400', 'border-gray-600', 'hover:bg-gray-800');
                    
                    updateChart(this.dataset.filter);
                });
            });
            // é»˜è®¤æ¿€æ´»ç¬¬ä¸€ä¸ªæŒ‰é’®
            btns[0].classList.add('bg-fuchsia-900', 'text-fuchsia-500', 'border-fuchsia-500/50');
            btns[0].classList.remove('text-gray-400', 'border-gray-600', 'hover:bg-gray-800');
        };


        // --- Event Listeners and Initial Load ---
        window.onload = () => {
             // Set today's date for trade entry default
             const today = new Date().toISOString().split('T')[0];
             document.getElementById('trade-date').value = today;
             
             tradeForm.addEventListener('submit', saveTrade);
             editForm.addEventListener('submit', updateTrade); // Listener for edit form
             
             setupChart(); // åˆå§‹åŒ–å›¾è¡¨
             setupChartFilters(); // Setup chart filtering logic
             firebaseInit();
        };

        // Expose functions globally for HTML calls
        window.openTradeModal = openTradeModal;
        window.closeTradeModal = closeTradeModal;
        window.openDetailModal = openDetailModal;
        window.closeDetailModal = closeDetailModal;
        window.openEditModal = openEditModal; 
        window.closeEditModal = closeEditModal; 
        window.openConfirmDeleteModal = openConfirmDeleteModal;
        window.closeConfirmDeleteModal = closeConfirmDeleteModal;
        window.saveInitialCapital = saveInitialCapital; 
        window.applyLogFilter = applyLogFilter; 
        window.deleteTrade = deleteTrade;
        
    </script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

<script>
  // 1. ç²˜è´´ä½ ä» Firebase å¤åˆ¶çš„é…ç½®ä¿¡æ¯
 const firebaseConfig = {
  apiKey: "AIzaSyDhzGgJ-Jjb6Ouztk2aV3WvPHimEJ1wagU",
  authDomain: "jinmu-c0549.firebaseapp.com",
  projectId: "jinmu-c0549",
  storageBucket: "jinmu-c0549.firebasestorage.app",
  messagingSenderId: "433198268542",
  appId: "1:433198268542:web:e3a1bb8aedd22c4db8982f",
  measurementId: "G-YHBMGP6C6X"
};

  // 2. åˆå§‹åŒ– Firebase
  firebase.initializeApp(firebaseConfig);

  // 3. å¼•ç”¨ Firestore æ•°æ®åº“æœåŠ¡
  const db = firebase.firestore();

  // 4. å®šä¹‰ä¸€ä¸ªç®€å•çš„ä¿å­˜æ•°æ®çš„å‡½æ•°
  function saveTestData(inputData) {
      db.collection("messages").add({
          content: inputData,
          timestamp: firebase.firestore.FieldValue.serverTimestamp() // è®°å½•å†™å…¥æ—¶é—´
      })
      .then((docRef) => {
          console.log("æ•°æ®å†™å…¥æˆåŠŸï¼Œæ–‡æ¡£ ID: ", docRef.id);
          alert("æ•°æ®å·²æˆåŠŸå­˜å‚¨åˆ° Firebaseï¼è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚");
      })
      .catch((error) => {
          console.error("å†™å…¥æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: ", error);
          alert("æ•°æ®å­˜å‚¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°å’Œ Firebase è§„åˆ™ã€‚");
      });
  }

  // 5. ç¤ºä¾‹ï¼šåœ¨é¡µé¢åŠ è½½åè‡ªåŠ¨å°è¯•å†™å…¥ä¸€æ¡æ•°æ®
  // å®é™…é¡¹ç›®ä¸­ä½ ä¼šæŠŠå®ƒç»‘å®šåˆ°æŒ‰é’®ç‚¹å‡»äº‹ä»¶ä¸Š
  // saveTestData("ç½‘ç«™é¦–æ¬¡è‡ªåŠ¨æµ‹è¯•å†™å…¥æ•°æ®"); 
<input type="text" id="dataInput" placeholder="è¾“å…¥è¦å­˜å‚¨çš„æ•°æ®">
<button onclick="saveTestData(document.getElementById('dataInput').value)">å­˜å‚¨æ•°æ®</button>
</script>

</body>
</html>



