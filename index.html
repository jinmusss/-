<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JINMU PRO ULTIMATE - 目标矩阵</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Great+Vibes&display=swap');
        
        /* Flatpickr Customization */
        .flatpickr-calendar {
            background: rgba(17, 17, 34, 0.95) !important;
            backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            box-shadow: 0 0 30px rgba(0,0,0,0.5) !important;
            font-family: 'Inter', sans-serif !important;
            border-radius: 1rem !important;
        }
        .flatpickr-months .flatpickr-month {
            background: transparent !important;
            color: #fff !important;
            fill: #fff !important;
        }
        .flatpickr-current-month .flatpickr-monthDropdown-months {
            background: transparent !important;
            color: #fff !important;
            font-weight: 700 !important;
        }
        .flatpickr-current-month input.cur-year {
            color: #fff !important;
            font-weight: 700 !important;
        }
        .flatpickr-day {
            color: #9ca3af !important;
            border-radius: 8px !important;
            border: 1px solid transparent !important;
        }
        .flatpickr-day:hover {
            background: rgba(255,255,255,0.05) !important;
            border-color: rgba(255,255,255,0.1) !important;
            color: #fff !important;
        }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
            background: #d946ef !important;
            border-color: #d946ef !important;
            color: #000 !important;
            font-weight: 900 !important;
            box-shadow: 0 0 15px rgba(217, 70, 239, 0.4) !important;
        }
        .flatpickr-day.today {
            border-color: #d946ef !important;
            color: #d946ef !important;
        }
        .flatpickr-day.today:hover {
            background: #d946ef !important;
            color: #000 !important;
        }
        .flatpickr-time {
            border-top: 1px solid rgba(255,255,255,0.08) !important;
        }
        .flatpickr-time .flatpickr-time-separator, .flatpickr-time .flatpickr-am-pm {
            color: #fff !important;
        }
        .flatpickr-time input {
            color: #fff !important;
        }
        span.flatpickr-weekday {
            background: transparent !important;
            color: #64748b !important;
            font-weight: 900 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.1em !important;
        }

        
        body {
            font-family: 'Inter', sans-serif;
            /* background-image: url("images/bj.jpg"); */
            /* background-size: cover; */
            /* background-position: center; */
            /* background-attachment: fixed; */
            /* background-repeat: no-repeat; */
            background-color: #000;
            color: #fff;
            min-height: 100vh;
        }

        #bg-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -100;
            background-size: cover;
            object-fit: cover;
        }

        #video-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(5, 5, 10, 0.75);
        z-index: -99;
        backdrop-filter: blur(3px);
        opacity: 0;
        transition: opacity 0.8s ease-in-out;
    }

        /* 磨砂玻璃效果增强 */
        .component-bg { 
            background-color: rgba(20, 20, 35, 0.7); 
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Custom Scrollbar for Dropdowns */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }

        /* Fixed Footer Style */
        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(17, 17, 34, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            padding: 0.5rem 1.5rem;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            color: #64748b;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Nav & Tab Styles */
        .nav-link {
            position: relative;
            color: #9ca3af;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s;
            cursor: pointer;
            padding: 0.5rem 1rem;
        }
        .nav-link:hover, .nav-link.active { color: #fff; }
        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -4px; left: 0; width: 100%; height: 2px;
            background: #d946ef;
            box-shadow: 0 0 10px #d946ef;
        }

        .view-section { display: none; animation: fadeIn 0.4s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Table Optimization */
        th, td { vertical-align: middle; white-space: nowrap; }

        .input-dark { background-color: rgba(5, 5, 10, 0.8) !important; border: 1px solid #3d3d5c !important; color: white !important; font-size: 14px !important; }
        .hidden-view { display: none !important; }
        
        /* 进度条动画 */
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring__circle { transition: stroke-dashoffset 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); transform-origin: 50% 50%; }

        /* 日历强化 */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .calendar-day { aspect-ratio: 1/1.1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; font-size: 11px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }
        .calendar-day:hover { transform: scale(1.1); z-index: 10; box-shadow: 0 0 15px rgba(217, 70, 239, 0.3); }
        .day-profit { background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.5); color: #10b981; }
        .day-loss { background: rgba(244, 63, 94, 0.2); border: 1px solid rgba(244, 63, 94, 0.5); color: #f43f5e; }
        .day-empty { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); color: #64748b; }
        
        /* 指标卡片 */
        .metric-card { transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1); border-top: 2px solid transparent; }
        .metric-card:hover { border-top-color: #d946ef; background: rgba(22, 22, 50, 0.9); transform: translateY(-5px); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); }

        .cyber-button { background-image: linear-gradient(135deg, #c026d3, #7c3aed); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border: none; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3); }
        .cyber-button:hover { box-shadow: 0 0 25px rgba(217, 70, 239, 0.6); transform: scale(1.02); letter-spacing: 1px; }

        /* 强化日志行动画 */
        .trade-row { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; }
        .trade-row:hover { 
            background: linear-gradient(90deg, rgba(192, 38, 211, 0.2) 0%, rgba(20, 20, 40, 0.6) 100%); 
            transform: translateX(6px) scale(1.01); 
            box-shadow: inset 3px 0 0 0 #d946ef, 0 10px 40px -10px rgba(192, 38, 211, 0.3);
            z-index: 5;
        }
        .trade-row:hover .text-gray-400 { color: #f0abfc !important; text-shadow: 0 0 8px rgba(217, 70, 239, 0.4); }
        
        .action-icon { transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); width: 36px; height: 36px; border-radius: 10px; background: rgba(255,255,255,0.03); }
        .action-icon:hover { transform: scale(1.3) rotate(8deg); background: rgba(217, 70, 239, 0.2); color: #d946ef; box-shadow: 0 0 15px rgba(217, 70, 239, 0.4); }

        /* 弹窗弹出动画 */
        @keyframes modalIn {
            0% { opacity: 0; transform: scale(0.8) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-animate { animation: modalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #3d3d5c; border-radius: 10px; }

        /* 行情监控特定样式 */
        .price-up { color: #10b981; animation: flash-green 0.6s ease-out; }
        .price-down { color: #ef4444; animation: flash-red 0.6s ease-out; }

        @keyframes flash-green { 0% { background-color: rgba(16, 185, 129, 0.15); } 100% { background-color: transparent; } }
        @keyframes flash-red { 0% { background-color: rgba(239, 68, 68, 0.15); } 100% { background-color: transparent; } }
        
        .crypto-icon { font-size: 1.5rem; opacity: 0.8; }
        
        /* New Script Font & Glow Styles */
        .font-script { font-family: 'Great Vibes', cursive; }
        
        .glow-flow-text {
            color: #fff;
            text-shadow: 0 0 10px rgba(192, 38, 211, 0.5), 0 0 20px rgba(192, 38, 211, 0.3);
            animation: glow-breathe 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow-breathe {
            from {
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.5), 0 0 10px rgba(192, 38, 211, 0.5), 0 0 20px rgba(168, 85, 247, 0.3);
            }
            to {
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(232, 121, 249, 0.8), 0 0 30px rgba(192, 38, 211, 0.6), 0 0 40px rgba(168, 85, 247, 0.5);
            }
        }
        
        /* Rotating Border Glow for Login Box */
        .login-box-glow {
            position: relative;
            z-index: 0;
            overflow: hidden;
            border-radius: 1.5rem;
            padding: 3px !important; /* Make space for the border */
            background: transparent !important;
            box-shadow: 0 0 40px rgba(192, 38, 211, 0.2);
        }
        
        .login-box-glow::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(transparent, #a855f7, #d946ef, #fff, #d946ef, #a855f7, transparent 40%);
            animation: rotate-border 3s linear infinite;
            z-index: -2;
        }
        
        .login-box-glow::after {
            content: '';
            position: absolute;
            inset: 3px;
            background: rgba(17, 17, 34, 0.9);
            backdrop-filter: blur(20px);
            border-radius: calc(1.5rem - 3px);
            z-index: -1;
        }
        
        .login-box-content {
            position: relative;
            z-index: 1;
            padding: 2.5rem; /* p-10 equivalent */
            height: 100%;
            border-radius: 1.5rem;
        }
        
        @keyframes rotate-border {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="selection:bg-purple-600 selection:text-black">
    <video autoplay muted loop playsinline id="bg-video">
        <source src="bg.mp4" type="video/mp4">
    </video>
    <div id="video-overlay"></div>

    <!-- Auth View -->
    <div id="auth-view" class="min-h-screen relative overflow-hidden flex items-center justify-center p-8 hidden-view">
        <div class="absolute -top-24 -left-24 w-80 h-80 bg-purple-500/5 blur-[100px]"></div>
        <div class="absolute -bottom-24 -right-10 w-96 h-96 bg-indigo-500/5 blur-[120px]"></div>
        <div class="relative w-full max-w-md login-box-glow animate__animated animate__fadeInUp">
            <div class="login-box-content">
<div class="text-center mb-10">
                    <h1 class="text-5xl font-script glow-flow-text tracking-wider">Jinmu Trade</h1>
                    <p class="mt-4 text-[10px] font-black tracking-[0.6em] text-transparent bg-clip-text bg-gradient-to-r from-purple-300 via-pink-300 to-purple-300 uppercase animate-pulse drop-shadow-[0_0_8px_rgba(217,70,239,0.8)]">
                        Jinmu Always Win
                    </p>
                </div>
                <form id="auth-form" class="space-y-6">
                <div class="relative">
                    <i class="fas fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    <input type="email" id="auth-email" required class="w-full pl-10 p-5 rounded-2xl input-dark" placeholder="邮箱账号">
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    <input type="password" id="auth-password" required class="w-full pl-10 p-5 rounded-2xl input-dark" placeholder="密码">
                </div>
                <button type="submit" class="cyber-button w-full py-5 rounded-2xl font-black uppercase tracking-widest text-lg hover:shadow-purple-500/50">进入</button>
                <button type="button" id="btn-register" class="w-full text-gray-400 text-xs hover:text-purple-400 transition-colors">注册</button>
            </form>
            </div>
        </div>
    </div>

    <!-- Main View -->
    <div id="main-view" class="hidden-view p-4 md:p-6 max-w-[1800px] mx-auto w-full flex flex-col h-screen overflow-hidden">
        <!-- Top Navigation -->
        <header class="flex-none mb-4 flex justify-between items-center bg-[#111122]/90 backdrop-blur-md px-8 py-4 rounded-2xl border border-white/5 shadow-lg z-50">
            <div class="flex items-center space-x-8">
                <div class="flex items-center space-x-4">

                    <div>
                        <h1 class="text-2xl font-script glow-flow-text tracking-wide leading-none pt-1">Jinmu Trade</h1>
                    </div>
                </div>
                
                <nav class="hidden md:flex items-center space-x-6 ml-8">
                    <a onclick="switchView('dashboard')" id="nav-dashboard" class="nav-link active">Dashboard</a>
                    <a onclick="switchView('trades')" id="nav-trades" class="nav-link">Trades</a>
                    <a onclick="switchView('analytics')" id="nav-analytics" class="nav-link">Analytics</a>
                    <a onclick="switchView('settings')" id="nav-settings" class="nav-link">Settings</a>
                </nav>
            </div>

            <div class="flex items-center space-x-6">
                <div class="flex flex-col items-end">
                    <span id="user-display-name" class="text-xs font-bold text-gray-300 tracking-wide">OPERATOR</span>
                    <span class="flex items-center text-[10px] text-emerald-500 uppercase font-bold tracking-wider">
                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full mr-1.5 animate-pulse"></span> Online
                    </span>
                </div>
                <div class="h-8 w-[1px] bg-white/10"></div>
                <button id="btn-logout" class="text-gray-400 hover:text-rose-500 transition-colors">
                    <i class="fas fa-power-off text-lg"></i>
                </button>
            </div>
        </header>

        <!-- Secondary Toolbar -->
        <div class="flex-none mb-6 flex flex-wrap gap-4 items-center justify-between px-2 overflow-visible">
            <div class="flex items-center space-x-2 bg-black/30 p-1.5 rounded-xl border border-white/5 backdrop-blur-sm relative z-[60]">
                
                <!-- Year Picker -->
                <div class="relative inline-block text-left" id="year-picker-container">
                    <button id="year-picker-btn" onclick="toggleYearPicker()" class="flex items-center px-3 py-1.5 rounded-lg hover:bg-white/5 transition-colors cursor-pointer text-xs font-bold text-white outline-none">
                        <i class="fas fa-calendar text-purple-400 mr-2 text-sm"></i>
                        <span id="year-picker-label">YYYY</span>
                        <i class="fas fa-chevron-down ml-2 text-[10px] text-gray-500"></i>
                    </button>
                    <input type="hidden" id="global-year">
                    <div id="year-picker-dropdown" class="hidden absolute left-0 top-full mt-2 w-24 rounded-xl component-bg border border-white/10 shadow-2xl z-[100] max-h-60 overflow-y-auto custom-scrollbar p-1"></div>
                </div>

                <div class="h-4 w-[1px] bg-white/10"></div>

                <!-- Month Picker -->
                <div class="relative inline-block text-left" id="month-picker-container">
                    <button id="month-picker-btn" onclick="toggleMonthPicker()" class="flex items-center px-3 py-1.5 rounded-lg hover:bg-white/5 transition-colors cursor-pointer text-xs font-bold text-white outline-none">
                        <span id="month-picker-label">MM月</span>
                        <i class="fas fa-chevron-down ml-2 text-[10px] text-gray-500"></i>
                    </button>
                    <input type="hidden" id="global-month">
                    <div id="month-picker-dropdown" class="hidden absolute left-0 top-full mt-2 w-24 rounded-xl component-bg border border-white/10 shadow-2xl z-[100] max-h-60 overflow-y-auto custom-scrollbar p-1"></div>
                </div>

                <div class="h-4 w-[1px] bg-white/10"></div>


            </div>
            
            <div class="flex items-center space-x-3">
                <button onclick="window.openModal()" class="bg-purple-600 hover:bg-purple-500 text-white px-5 py-2 rounded-lg text-xs font-bold transition-all shadow-lg shadow-purple-600/20 flex items-center">
                    <i class="fas fa-plus mr-2"></i> 记一笔
                </button>
                <button onclick="window.triggerImport()" class="bg-[#1a1a2e] hover:bg-[#252540] text-gray-300 px-4 py-2 rounded-lg text-xs font-bold border border-white/10 transition-all">
                    <i class="fas fa-file-import mr-2"></i> 导入
                </button>
                <button onclick="window.exportToCSV()" class="bg-[#1a1a2e] hover:bg-[#252540] text-gray-300 px-4 py-2 rounded-lg text-xs font-bold border border-white/10 transition-all">
                    <i class="fas fa-file-export mr-2"></i> 导出
                </button>
            </div>
        </div>

        <!-- Scrollable Content Area -->
        <main class="flex-grow overflow-y-auto pr-2 space-y-8 scroll-smooth" id="content-container">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section active space-y-6">
                <!-- 整合：实时行情监控 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- BTC 卡片 -->
                <div id="btcusdt" class="component-bg rounded-2xl p-6 shadow-2xl transition-all duration-300 hover:scale-[1.02] border-t-2 border-transparent hover:border-t-[#F7931A]">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest">Bitcoin</h3>
                            <span class="text-xl font-black">BTC / USDT</span>
                        </div>
                        <i class="fa-brands fa-bitcoin text-[#F7931A] crypto-icon"></i>
                    </div>
                    <div id="btc-price" class="text-3xl font-black tracking-tighter mb-2">0.00</div>
                    <div class="flex items-center gap-2">
                        <span id="btc-change" class="text-sm font-bold px-2 py-1 rounded bg-white/5">--%</span>
                        <span class="text-gray-500 text-xs uppercase">24h Change</span>
                    </div>
                </div>

                <!-- ETH 卡片 -->
                <div id="ethusdt" class="component-bg rounded-2xl p-6 shadow-2xl transition-all duration-300 hover:scale-[1.02] border-t-2 border-transparent hover:border-t-[#627EEA]">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest">Ethereum</h3>
                            <span class="text-xl font-black">ETH / USDT</span>
                        </div>
                        <i class="fa-brands fa-ethereum text-[#627EEA] crypto-icon"></i>
                    </div>
                    <div id="eth-price" class="text-3xl font-black tracking-tighter mb-2">0.00</div>
                    <div class="flex items-center gap-2">
                        <span id="eth-change" class="text-sm font-bold px-2 py-1 rounded bg-white/5">--%</span>
                        <span class="text-gray-500 text-xs uppercase">24h Change</span>
                    </div>
                </div>

                <!-- DOGE 卡片 -->
                <div id="dogeusdt" class="component-bg rounded-2xl p-6 shadow-2xl transition-all duration-300 hover:scale-[1.02] border-t-2 border-transparent hover:border-t-[#C2A633]">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest">Dogecoin</h3>
                            <span class="text-xl font-black">DOGE / USDT</span>
                        </div>
                        <i class="fa-solid fa-paw text-[#C2A633] crypto-icon"></i>
                    </div>
                    <div id="doge-price" class="text-3xl font-black tracking-tighter mb-2">0.00</div>
                    <div class="flex items-center gap-2">
                        <span id="doge-change" class="text-sm font-bold px-2 py-1 rounded bg-white/5">--%</span>
                        <span class="text-gray-500 text-xs uppercase">24h Change</span>
                    </div>
                </div>
            </div>

            <!-- 顶层：目标进度与设置 + 专业指标 -->
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
                <div class="xl:col-span-4 p-8 rounded-3xl component-bg border border-purple-500/20 relative overflow-hidden shadow-2xl">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-purple-500/5 blur-3xl rounded-full"></div>
                    <div class="flex items-center justify-between mb-8">
                        <span class="text-xs text-purple-400 font-black uppercase tracking-[0.25em]">Account Growth Tracker</span>
                        <i class="fas fa-radar text-gray-700"></i>
                    </div>
                    
                    <div class="flex flex-col md:flex-row items-center gap-10">
                        <div class="relative flex items-center justify-center shrink-0 group">
                            <div class="absolute inset-0 bg-purple-500/10 blur-2xl rounded-full scale-0 group-hover:scale-110 transition-transform duration-700"></div>
                            <svg class="progress-ring relative" width="140" height="140">
                                <circle class="text-white/5" stroke-width="10" stroke="currentColor" fill="transparent" r="62" cx="70" cy="70"/>
                                <circle id="goal-progress-bar" class="text-purple-400 progress-ring__circle" stroke-width="10" stroke-dasharray="389.5" stroke-dashoffset="389.5" stroke-linecap="round" stroke="currentColor" fill="transparent" r="62" cx="70" cy="70"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="goal-percent" class="text-3xl font-black text-white tracking-tighter">0%</span>
                            </div>
                        </div>

                        <div class="flex-grow w-full space-y-6">
                            <div class="grid grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-[11px] text-gray-400 uppercase font-black tracking-widest">初始资金 (Base)</label>
                                    <div class="flex items-center bg-black/40 px-4 py-3 rounded-xl border border-white/5 focus-within:border-purple-500/50 transition-all">
                                        <span class="text-purple-500 font-black mr-2">$</span>
                                        <input type="number" id="initial-capital" class="bg-transparent border-none p-0 text-white font-black text-base w-full focus:ring-0" value="10000">
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[11px] text-gray-400 uppercase font-black tracking-widest">目标资金 (Target)</label>
                                    <div class="flex items-center bg-black/40 px-4 py-3 rounded-xl border border-white/5 focus-within:border-purple-500/50 transition-all">
                                        <span class="text-purple-500 font-black mr-2">$</span>
                                        <input type="number" id="target-capital" class="bg-transparent border-none p-0 text-white font-black text-base w-full focus:ring-0" value="20000">
                                    </div>
                                </div>
                            </div>
                            <div class="pt-4 border-t border-white/5">
                                <p id="remaining-label" class="text-xs text-gray-400 italic font-medium tracking-tight">AI 正在解析目标路径...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 仓位计算器小组件 -->
                <div class="xl:col-span-2 p-6 rounded-3xl component-bg border border-blue-500/20 shadow-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-xs text-blue-400 font-black uppercase tracking-[0.25em]">仓位计算器</span>
                        <i class="fas fa-calculator text-gray-700"></i>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest">风险金额</label>
                            <div class="flex items-center bg-black/40 px-3 py-2 rounded-xl border border-white/5 focus-within:border-blue-500/50 transition-all">
                                <span class="text-blue-500 font-black mr-2">$</span>
                                <input type="number" id="calc-risk-amount" class="bg-transparent border-none p-0 text-white font-black text-sm w-full focus:ring-0" placeholder="100">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 uppercase font-black tracking-widest">风险值 (%)</label>
                            <div class="flex items-center bg-black/40 px-3 py-2 rounded-xl border border-white/5 focus-within:border-blue-500/50 transition-all">
                                <i class="fas fa-percent text-blue-500 text-xs mr-2"></i>
                                <input type="number" id="calc-risk-percent" class="bg-transparent border-none p-0 text-white font-black text-sm w-full focus:ring-0" placeholder="1.0" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center bg-white/5 rounded-xl px-3 py-2 mt-3">
                        <span class="text-[10px] text-gray-500 uppercase font-black tracking-widest">仓位大小</span>
                        <span id="calc-result" class="text-xl font-black text-white tracking-tight">$0.00</span>
                    </div>
                </div>

                <div class="xl:col-span-6 grid grid-cols-2 md:grid-cols-4 gap-5" id="metrics-grid"></div>
            </div>

            <!-- 中间：日历与曲线 -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 xl:col-span-3 p-8 rounded-3xl component-bg border border-white/10 shadow-xl">
                    <div class="flex flex-col space-y-6 mb-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-sm font-black text-white uppercase tracking-widest flex items-center"><i class="fas fa-calendar-alt mr-3 text-purple-400"></i>交易日历</h3>
                            <button id="btn-current-month" class="px-3 py-1.5 text-[10px] bg-white/5 rounded-lg text-gray-400 hover:bg-purple-500 hover:text-black font-black transition-all">当前月</button>
                        </div>
                        <div class="flex space-x-3">
                            <input type="month" id="calendar-month-select" class="flex-grow bg-[#05050a] border border-[#2d2d4c] text-purple-400 text-xs px-4 py-3 rounded-xl outline-none font-black">
                            <button onclick="window.changeMonth(-1)" class="w-10 h-10 bg-white/5 rounded-xl hover:text-purple-400 transition-colors"><i class="fas fa-chevron-left"></i></button>
                            <button onclick="window.changeMonth(1)" class="w-10 h-10 bg-white/5 rounded-xl hover:text-purple-400 transition-colors"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-[10px] text-gray-600 mb-3 text-center uppercase font-black tracking-widest">
                        <div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div><div>日</div>
                    </div>
                    <div id="calendar-heatmap" class="calendar-grid"></div>
                    <div class="mt-8 pt-6 border-t border-white/5 flex justify-between items-center">
                        <div>
                            <p class="text-[10px] text-gray-500 uppercase font-black tracking-widest mb-1">视图盈亏</p>
                            <p id="view-pnl" class="text-xl font-black font-mono">+$0.00</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[10px] text-gray-500 uppercase font-black tracking-widest mb-1">本月收益率</p>
                            <p id="view-roi" class="text-xl font-black font-mono text-white">0.00%</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-gray-500 uppercase font-black tracking-widest mb-1">交易次数</p>
                            <p id="view-count" class="text-xl font-black font-mono text-white">0</p>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 xl:col-span-9 p-8 rounded-3xl component-bg shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-purple-500/5 blur-[100px] pointer-events-none"></div>
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-sm font-black text-gray-400 uppercase tracking-[0.3em]"><i class="fas fa-wave-square mr-3 text-purple-500"></i>Equity Curve Analytics</h3>
                        <div class="flex bg-black/40 rounded-lg p-1 border border-white/5">
                            <button id="chart-mode-view" class="px-3 py-1 text-[10px] font-black rounded-md text-gray-400 hover:text-white transition-all">VIEW</button>
                            <button id="chart-mode-all" class="px-3 py-1 text-[10px] font-black rounded-md bg-purple-500 text-black shadow-lg shadow-purple-500/20">ALL</button>
                        </div>
                    </div>
                    <div class="h-[380px] w-full"><canvas id="equity-chart"></canvas></div>
                </div>
            </div>

            </div> <!-- End Dashboard View -->

            <!-- VIEW: TRADES (Table) -->
            <div id="view-trades" class="view-section space-y-6">
                <div class="p-6 rounded-3xl component-bg border border-white/5 shadow-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-white flex items-center"><i class="fas fa-list-ul mr-3 text-purple-400"></i> Trade Journal</h3>
                        <div class="flex space-x-2">
                             <input type="text" id="table-search" placeholder="Search..." class="bg-black/30 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-white focus:border-purple-500 outline-none">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="text-left text-[10px] uppercase text-gray-500 font-bold tracking-wider border-b border-white/5">
                                    <th class="px-4 py-4 cursor-pointer hover:text-white">Date / 时间</th>
                                    <th class="px-4 py-4 cursor-pointer hover:text-white">Symbol / 交易对</th>
                                    <th class="px-4 py-4 text-center cursor-pointer hover:text-white">Side / 方向</th>
                                    <th class="px-4 py-4 text-right cursor-pointer hover:text-white">PnL / 盈亏 ($)</th>
                                    <th class="px-4 py-4 text-right">Action / 操作</th>
                                </tr>
                            </thead>
                            <tbody id="trade-list" class="divide-y divide-white/5 text-xs font-medium text-gray-300"></tbody>
                        </table>
                        <div id="empty-state" class="hidden py-20 text-center text-gray-600">
                            <i class="fas fa-inbox text-4xl mb-3"></i>
                            <p class="text-xs">No records found matching filters.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: ANALYTICS -->
            <div id="view-analytics" class="view-section">
                <div class="p-10 rounded-3xl component-bg border border-white/5 flex flex-col items-center justify-center text-gray-500 min-h-[400px]">
                    <i class="fas fa-chart-pie text-5xl mb-4 text-gray-700"></i>
                    <p class="text-sm uppercase tracking-widest font-bold">Analytics Module Coming Soon</p>
                </div>
            </div>

            <!-- VIEW: SETTINGS -->
            <div id="view-settings" class="view-section">
                <div class="p-10 rounded-3xl component-bg border border-white/5 min-h-[400px]">
                    <h3 class="text-lg font-bold text-white mb-6">Settings</h3>
                    <p class="text-gray-500 text-sm">User preferences and account configuration.</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Trade Modal -->
    <div id="trade-modal" class="fixed inset-0 hidden flex justify-center items-center p-4 z-[200] bg-black/95 backdrop-blur-md">
        <div class="bg-[#111122] border border-[#2d2d4c] p-10 rounded-[2.5rem] w-full max-w-xl shadow-[0_0_100px_-20px_rgba(217,70,239,0.3)] modal-animate">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 class="text-2xl font-black text-white uppercase tracking-tighter">录入成交数据</h3>
                    <p class="text-[10px] text-purple-500 font-black uppercase mt-1 tracking-widest">Transaction Entry Protocol</p>
                </div>
                <button onclick="window.closeModal()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 text-gray-500 hover:text-white transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <form id="trade-form" class="grid grid-cols-2 gap-5">
                <input type="hidden" id="edit-id">
                
                <div class="col-span-1 space-y-1">
                    <label class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Symbol / 交易对</label>
                    <input id="trade-pair" type="text" placeholder="BTCUSDT" required class="w-full p-3 bg-[#05050a] text-white rounded-xl border border-[#3d3d5c] text-sm focus:border-purple-500 outline-none font-mono">
                </div>
                
                <div class="col-span-1 space-y-1">
                    <label class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Date / 时间</label>
                    <input id="trade-date" type="text" required class="w-full p-3 bg-[#05050a] text-white rounded-xl border border-[#3d3d5c] text-sm focus:border-purple-500 outline-none font-mono cursor-pointer" placeholder="选择时间...">
                </div>

                <div class="col-span-1 space-y-1">
                    <label class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Side / 方向</label>
                    <select id="trade-direction" class="w-full p-3 bg-[#05050a] text-white rounded-xl border border-[#3d3d5c] text-sm focus:border-purple-500 outline-none">
                        <option value="Long">Long (做多)</option>
                        <option value="Short">Short (做空)</option>
                    </select>
                </div>

                <div class="col-span-1 space-y-1">
                    <label class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">PnL / 盈亏 ($)</label>
                    <input id="trade-profit" type="number" step="0.01" required class="w-full p-3 bg-[#05050a] text-white rounded-xl border border-[#3d3d5c] text-sm focus:border-purple-500 outline-none font-mono">
                </div>

                <div class="col-span-2 space-y-1">
                    <label class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Chart Link / 图表链接</label>
                    <input id="trade-tv-link" type="url" placeholder="TradingView URL..." class="w-full p-3 bg-[#05050a] text-white rounded-xl border border-[#3d3d5c] text-sm focus:border-purple-500 outline-none">
                </div>
                
                <div class="col-span-2 pt-4">
                    <button type="submit" class="cyber-button w-full py-4 rounded-xl font-bold uppercase tracking-widest text-sm shadow-lg shadow-purple-500/30">保存</button>
                </div>
            </form>
        </div>
    </div>



    <!-- Hidden File Input for Import -->
    <input type="file" id="import-file" accept=".csv" class="hidden" onchange="processImport(this)">

    <!-- 实时行情 Websocket 脚本 -->
    <script>
        const symbols = ['btcusdt', 'ethusdt', 'dogeusdt'];
        const streamUrl = `wss://stream.binance.com:9443/stream?streams=${symbols.map(s => s + '@ticker').join('/')}`;
        const ws = new WebSocket(streamUrl);
        const lastPrices = {};

        ws.onmessage = (event) => {
            const { data } = JSON.parse(event.data);
            const symbol = data.s.toLowerCase();
            const price = parseFloat(data.c).toLocaleString(undefined, {
                minimumFractionDigits: symbol === 'dogeusdt' ? 4 : 2,
                maximumFractionDigits: symbol === 'dogeusdt' ? 4 : 2
            });
            const rawPrice = parseFloat(data.c);
            const changePercent = data.P;
            
            updatePriceUI(symbol, price, rawPrice, changePercent);
        };

        function updatePriceUI(symbol, displayPrice, rawPrice, change) {
            const coinPrefix = symbol.replace('usdt', '');
            const priceEl = document.getElementById(`${coinPrefix}-price`);
            const changeEl = document.getElementById(`${coinPrefix}-change`);

            if (!priceEl) return;

            // 价格闪烁效果
            if (lastPrices[symbol]) {
                priceEl.classList.remove('price-up', 'price-down');
                void priceEl.offsetWidth; // 触发回流重启动画
                if (rawPrice > lastPrices[symbol]) {
                    priceEl.classList.add('price-up');
                } else if (rawPrice < lastPrices[symbol]) {
                    priceEl.classList.add('price-down');
                }
            }
            
            priceEl.innerText = displayPrice;
            lastPrices[symbol] = rawPrice;

            // 涨跌幅样式
            const isPositive = parseFloat(change) >= 0;
            changeEl.innerText = `${isPositive ? '↑' : '↓'} ${Math.abs(change)}%`;
            changeEl.style.color = isPositive ? '#10b981' : '#ef4444';
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyDhzGgJ-Jjb6Ouztk2aV3WvPHimEJ1wagU","authDomain":"jinmu-c0549.firebaseapp.com","projectId":"jinmu-c0549","storageBucket":"jinmu-c0549.firebasestorage.app","messagingSenderId":"433198268542","appId":"1:433198268542:web:e3a1bb8aedd22c4db8982f"}');
const appId = 'jinmu-v8-ultra-isolated'; // 使用隔离版 ID

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let allTrades = [];
let config = { initialCapital: 10000, targetCapital: 20000 };
let chartInstance = null;
let viewMode = 'month';
let chartMode = 'all';
let unsubscribeTrades = null;

// 初始化身份验证（支持环境自动登录）
const initAuth = async () => {
    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
    } else {
        // 如果没有预设 token，不强制匿名登录，让用户手动输入
    }
};
initAuth();

onAuthStateChanged(auth, async (user) => {
    if (user) {
        document.getElementById('video-overlay').style.opacity = '1';
        document.getElementById('auth-view').classList.add('hidden-view');
        document.getElementById('main-view').classList.remove('hidden-view');
        document.getElementById('user-display-name').textContent = (user.email ? user.email.split('@')[0] : 'USER').toUpperCase();
        
        // 1. 获取独立配置
        const configRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config');
        const configSnap = await getDoc(configRef);
        if (configSnap.exists()) {
            config = { ...config, ...configSnap.data() };
            document.getElementById('initial-capital').value = config.initialCapital;
            document.getElementById('target-capital').value = config.targetCapital;
        }

        const now = new Date();
        const currentMonthVal = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        
        // Initialize Custom Date Picker
        initPickers();

        // 2. 数据隔离监听
        if (unsubscribeTrades) unsubscribeTrades();
        unsubscribeTrades = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'trades'), (snap) => {
            allTrades = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            document.getElementById('last-sync-time').textContent = `上次同步: ${new Date().toLocaleTimeString()}`;
            populateFilters();
            refreshUI();
        });
    } else {
        document.getElementById('video-overlay').style.opacity = '0';
        document.getElementById('main-view').classList.add('hidden-view');
        document.getElementById('auth-view').classList.remove('hidden-view');
        if (unsubscribeTrades) unsubscribeTrades();
    }
});

// View Switching Logic
window.switchView = (viewId) => {
    // Update Nav
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    document.getElementById(`nav-${viewId}`)?.classList.add('active');
    
    // Update View Sections
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById(`view-${viewId}`)?.classList.add('active');
    
    // Refresh UI if needed (e.g. resizing charts)
    if (viewId === 'dashboard' || viewId === 'analytics') refreshUI();
};

function populateFilters() {
    renderYearDropdown();
    renderMonthDropdown();
}

const saveConfig = async () => {
    if (!auth.currentUser) return;
    config.initialCapital = parseFloat(document.getElementById('initial-capital').value) || 10000;
    config.targetCapital = parseFloat(document.getElementById('target-capital').value) || 20000;
    await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'settings', 'config'), config);
    refreshUI();
};
document.getElementById('initial-capital').onchange = saveConfig;
document.getElementById('target-capital').onchange = saveConfig;

// --- 以下是保持不变的 UI 渲染逻辑 ---

function refreshUI() {
    allTrades.sort((a, b) => new Date(a.date) - new Date(b.date));
    const now = new Date();
    let filtered = [];
    
    const y = Number(document.getElementById('global-year').value);
    const m = Number(document.getElementById('global-month').value);
    
    filtered = allTrades.filter(t => {
        const d = new Date(t.date);
        return d.getFullYear() === y && (d.getMonth() + 1) === m;
    });

    updateGoalProgress(allTrades);
    updateMetricCards(allTrades); 
    
    // Sync Calendar Widget Month (if it exists)
    const calSelect = document.getElementById('calendar-month-select');
    if (calSelect) calSelect.value = `${y}-${String(m).padStart(2,'0')}`;

    renderCalendar(allTrades); // Calendar heatmap usually shows whole month data regardless of other filters? Or filtered? Let's pass allTrades for now to show all activity in that month.
    renderTradeList(filtered);
    updateChart(allTrades, filtered); // Equity chart needs base equity (allTrades) and view data (filtered)
}

function updateGoalProgress(all) {
    const initial = config.initialCapital;
    const target = config.targetCapital;
    let currentEquity = initial;
    all.forEach(t => currentEquity += t.profit);
    const neededToEarn = target - initial;
    const alreadyEarned = currentEquity - initial;
    let progress = neededToEarn > 0 ? Math.max(0, (alreadyEarned / neededToEarn) * 100) : 0;
    document.getElementById('goal-percent').textContent = `${progress.toFixed(1)}%`;
    const circle = document.getElementById('goal-progress-bar');
    const circumference = 389.5; 
    circle.style.strokeDashoffset = circumference - (Math.min(100, progress) / 100 * circumference);
    const remaining = target - currentEquity;
    document.getElementById('remaining-label').textContent = remaining > 0 ? `距目标还差 $${remaining.toLocaleString()}` : 'GOAL REACHED / 目标已达成';
    document.getElementById('remaining-label').className = remaining > 0 ? 'text-xs text-gray-400 italic font-bold' : 'text-xs text-emerald-400 font-black animate-pulse';
}

function updateMetricCards(all) {
    const initial = config.initialCapital;
    let currentEquity = initial;
    let maxEquity = initial;
    let maxDD = 0, totalProfit = 0, totalLoss = 0, winCount = 0, lossCount = 0, totalR = 0;
    all.forEach(t => {
        currentEquity += t.profit;
        totalR += t.r;
        if (t.profit > 0) { totalProfit += t.profit; winCount++; }
        else { totalLoss += Math.abs(t.profit); lossCount++; }
        if (currentEquity > maxEquity) maxEquity = currentEquity;
        const dd = ((maxEquity - currentEquity) / maxEquity) * 100;
        if (dd > maxDD) maxDD = dd;
    });
    const wr = all.length ? (winCount / all.length * 100) : 0;
    const pf = totalLoss === 0 ? totalProfit : (totalProfit / totalLoss);
    const roi = initial > 0 ? ((currentEquity - initial) / initial) * 100 : 0;
    
    const metrics = [
        { label: '账户总资产', val: `${currentEquity.toFixed(2)}`, sub: '当前余额 (Balance)', cls: 'text-white' },
        { label: '统计胜率', val: `${wr.toFixed(1)}%`, sub: `${winCount}胜 / ${lossCount}负`, cls: 'text-purple-400' },
        { label: '盈亏系数 PF', val: pf.toFixed(2), sub: '盈亏比 (Factor)', cls: pf >= 1.5 ? 'text-emerald-400' : 'text-amber-400' },
        { label: '极限回撤 DD', val: `${maxDD.toFixed(1)}%`, sub: '最大回撤 (Drawdown)', cls: 'text-rose-400' },
        { label: '单笔均值 R', val: `${(totalR/Math.max(1,all.length)).toFixed(2)}R`, sub: '平均R值 (Avg R)', cls: 'text-indigo-400' },
        { label: '总收益率 ROI', val: `${roi > 0 ? '+' : ''}${roi.toFixed(2)}%`, sub: '总回报率 (Return)', cls: roi >= 0 ? 'text-emerald-500' : 'text-rose-500' },
        { label: '核心净利润', val: `${(currentEquity - initial).toFixed(2)}`, sub: '净利润 (Net Profit)', cls: (currentEquity >= initial) ? 'text-emerald-400' : 'text-rose-400' },
        { label: '总交易数', val: all.length, sub: '总笔数 (Count)', cls: 'text-gray-400' }
    ];
    document.getElementById('metrics-grid').innerHTML = metrics.map(m => `
        <div class="metric-card p-6 rounded-2xl component-bg border border-white/5">
            <p class="text-[11px] uppercase text-gray-500 font-black tracking-widest mb-3">${m.label}</p>
            <p class="text-2xl font-black ${m.cls}">${m.val}</p>
            <p class="text-[10px] text-gray-600 mt-2 uppercase font-black tracking-tight">${m.sub}</p>
        </div>`).join('');
}

function renderCalendar(data) {
    const y = Number(document.getElementById('global-year').value);
    const m = Number(document.getElementById('global-month').value);
    const year = y || new Date().getFullYear();
    const month = (m ? Number(m) : (new Date().getMonth() + 1)) - 1;
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const startOffset = (firstDay === 0 ? 6 : firstDay - 1);
    const dailyPnL = {};
    data.forEach(t => {
        const d = new Date(t.date);
        if (d.getFullYear() === year && d.getMonth() === month) {
            const day = d.getDate();
            dailyPnL[day] = (dailyPnL[day] || 0) + t.profit;
        }
    });
    let html = '';
    for (let i = 0; i < startOffset; i++) html += '<div class="calendar-day opacity-0 pointer-events-none"></div>';
    for (let d = 1; d <= daysInMonth; d++) {
        const pnl = dailyPnL[d];
        let cls = 'day-empty', pnlLabel = '';
        if (pnl !== undefined) { 
            cls = pnl >= 0 ? 'day-profit' : 'day-loss'; 
            pnlLabel = `<span class="font-black mt-1">${pnl >= 0 ? '+' : ''}${Math.round(pnl)}</span>`; 
        }
        html += `<div class="calendar-day ${cls} cursor-pointer group"><span class="opacity-50 font-bold group-hover:opacity-100">${d}</span>${pnlLabel}</div>`;
    }
    document.getElementById('calendar-heatmap').innerHTML = html;
}

function renderTradeList(filteredData) {
    const search = document.getElementById('table-search')?.value.toUpperCase() || "";
    // filter-status was removed in HTML, so we ignore it or add it back to toolbar if needed.
    // The new toolbar has strategy/pair.
    
    const list = filteredData.filter(t => {
        const matchSearch = (t.pair + t.strategy + t.tags).toUpperCase().includes(search);
        return matchSearch;
    });
    
    const body = document.getElementById('trade-list');
    const empty = document.getElementById('empty-state');
    // document.getElementById('log-count').textContent = list.length; // Removed in new HTML
    
    if (list.length === 0) { body.innerHTML = ''; empty.classList.remove('hidden'); return; }
    empty.classList.add('hidden');
    
    body.innerHTML = list.slice().reverse().map(t => {
        const tvLink = t.tvLink || `https://www.tradingview.com/chart/?symbol=${t.pair.replace('/','')}`;
        const pnlClass = t.profit >= 0 ? 'text-emerald-400' : 'text-rose-400';
        const pnlSign = t.profit >= 0 ? '+' : '';
        
        return `
        <tr class="trade-row border-b border-white/5 hover:bg-white/5 transition-colors">
            <td class="px-4 py-4 text-gray-400 font-mono">${new Date(t.date).toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'})}</td>
            <td class="px-4 py-4 font-bold text-white tracking-tight">${t.pair}</td>
            <td class="px-4 py-4 text-center">
                <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${t.direction === 'Long' ? 'bg-emerald-500/10 text-emerald-400' : 'bg-rose-500/10 text-rose-400'}">
                    ${t.direction}
                </span>
            </td>
            <td class="px-4 py-4 text-right font-bold text-sm ${pnlClass}">${pnlSign}${t.profit.toFixed(2)}</td>
            <td class="px-4 py-4 text-right">
                <div class="flex items-center justify-end space-x-2">
                    ${t.tvLink ? `<a href="${t.tvLink}" target="_blank" class="text-gray-500 hover:text-purple-400 transition-colors" title="Chart"><i class="fas fa-chart-line"></i></a>` : ''}
                    <button onclick="window.editTrade('${t.id}')" class="text-gray-500 hover:text-white transition-colors">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="window.deleteTrade('${t.id}')" class="text-gray-500 hover:text-rose-500 transition-colors">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </td>
        </tr>
    `}).join('');
}

function updateChart(all, viewData) {
    const initial = config.initialCapital;
    let currentViewPnL = 0, baseEquity = initial;

    // 1. Calculate View Stats (Selected Month Data)
    const y = Number(document.getElementById('global-year').value);
    const m = Number(document.getElementById('global-month').value);
    const monthStart = new Date(y, m - 1, 1);
    
    // Calculate PnL for the View (Month)
    viewData.forEach(t => currentViewPnL += t.profit);
    
    // Calculate Equity at the start of the selected month
    let preMonthProfit = 0;
    all.forEach(t => { 
        if (new Date(t.date) < monthStart) preMonthProfit += t.profit; 
    });
    baseEquity = initial + preMonthProfit;

    // Update Stats DOM (Always reflect the selected Month/View Stats)
    document.getElementById('view-pnl').textContent = `${currentViewPnL >= 0 ? '+' : ''}$${currentViewPnL.toFixed(2)}`;
    document.getElementById('view-pnl').className = `text-2xl font-black font-mono mt-1 ${currentViewPnL >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
    document.getElementById('view-count').textContent = viewData.length;
    
    const monthROI = baseEquity > 0 ? (currentViewPnL / baseEquity) * 100 : 0;
    document.getElementById('view-roi').textContent = `${monthROI > 0 ? '+' : ''}${monthROI.toFixed(2)}%`;
    document.getElementById('view-roi').className = `text-2xl font-black font-mono mt-1 ${monthROI >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
    
    // 2. Generate Chart Data based on chartMode
    const pts = [];
    
    if (chartMode === 'all') {
        // ALL Mode: From Initial Capital -> Now (All Trades)
        let running = initial;
        // Start point: 1 day before first trade or today
        if (all.length > 0) {
            pts.push({ x: new Date(new Date(all[0].date).getTime() - 86400000), y: initial });
        } else {
            pts.push({ x: new Date(), y: initial });
        }
        
        all.forEach(t => {
            running += t.profit;
            pts.push({ x: new Date(t.date), y: running });
        });
    } else {
        // VIEW Mode: Selected Month Equity Curve
        // Start point: 1st of the month with baseEquity
        pts.push({ x: monthStart, y: baseEquity });
        
        let running = baseEquity;
        viewData.forEach(t => {
            running += t.profit;
            pts.push({ x: new Date(t.date), y: running });
        });
    }
    
    const ctx = document.getElementById('equity-chart').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: { datasets: [{ 
            data: pts, borderColor: '#d946ef', borderWidth: 3, pointRadius: 4, pointBackgroundColor: '#d946ef', fill: true,
            backgroundColor: (c) => { 
                const g = c.chart.ctx.createLinearGradient(0, 0, 0, 400); 
                g.addColorStop(0, 'rgba(217, 70, 239, 0.2)'); 
                g.addColorStop(1, 'rgba(217, 70, 239, 0)'); 
                return g; 
            },
            tension: 0.15 
        }] },
        options: { 
            responsive: true, maintainAspectRatio: false, 
            plugins: { legend: { display: false }, tooltip: { padding: 12, backgroundColor: '#111122', titleFont: { size: 12, weight: 'bold' }, bodyFont: { size: 14, weight: 'black' } } },
            scales: { 
                x: { type: 'time', grid: { display: false }, ticks: { color: '#4b5563', font: {size: 10, weight: 'bold'} } }, 
                y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#4b5563', font: {size: 10, weight: 'bold'} } } 
            } 
        }
    });
}

window.changeMonth = (off) => {
    let y = Number(document.getElementById('global-year').value);
    let m = Number(document.getElementById('global-month').value);
    
    const date = new Date(y, m - 1 + off, 1);
    selectYear(date.getFullYear(), false);
    selectMonth(String(date.getMonth() + 1).padStart(2,'0'), true);
};

document.getElementById('btn-current-month').onclick = () => {
    const now = new Date();
    selectYear(now.getFullYear(), false);
    selectMonth(String(now.getMonth() + 1).padStart(2,'0'), true);
};

// document.getElementById('global-date-picker').onchange = refreshUI; // Deprecated
// document.getElementById('global-pair-filter').onchange = refreshUI; // Deprecated
document.getElementById('table-search')?.addEventListener('input', refreshUI);

// --- Custom Picker Logic (Year / Month / Pair) ---

// Initialize all pickers
window.initPickers = () => {
    const now = new Date();
    const currentY = now.getFullYear();
    const currentM = String(now.getMonth() + 1).padStart(2, '0');

    // Init Values if empty
    if(!document.getElementById('global-year').value) selectYear(currentY, false);
    if(!document.getElementById('global-month').value) selectMonth(currentM, false);
    
    // Render Dropdowns
    renderYearDropdown();
    renderMonthDropdown();
    
    // Close listeners
    document.addEventListener('click', (e) => {
        if (!document.getElementById('year-picker-container').contains(e.target)) {
            document.getElementById('year-picker-dropdown').classList.add('hidden');
        }
        if (!document.getElementById('month-picker-container').contains(e.target)) {
            document.getElementById('month-picker-dropdown').classList.add('hidden');
        }
    });
};

// Year Picker
window.toggleYearPicker = () => document.getElementById('year-picker-dropdown').classList.toggle('hidden');
window.renderYearDropdown = () => {
    const currentY = new Date().getFullYear();
    const startY = currentY - 2;
    const endY = currentY + 1;
    const selected = document.getElementById('global-year').value;
    let html = '';
    for (let y = endY; y >= startY; y--) {
        const isSelected = String(y) === String(selected);
        html += `
            <div onclick="selectYear('${y}')" 
                 class="px-4 py-2 text-xs font-bold text-gray-300 hover:bg-purple-500/20 hover:text-white cursor-pointer transition-colors flex justify-between items-center rounded-lg mb-1 ${isSelected ? 'bg-white/5 text-purple-400' : ''}">
                <span>${y}</span>
                ${isSelected ? '<i class="fas fa-check text-purple-500 text-[10px]"></i>' : ''}
            </div>`;
    }
    document.getElementById('year-picker-dropdown').innerHTML = html;
};
window.selectYear = (y, refresh = true) => {
    document.getElementById('global-year').value = y;
    document.getElementById('year-picker-label').textContent = y;
    document.getElementById('year-picker-dropdown').classList.add('hidden');
    renderYearDropdown(); 
    if(refresh) refreshUI();
};

// Month Picker
window.toggleMonthPicker = () => document.getElementById('month-picker-dropdown').classList.toggle('hidden');
window.renderMonthDropdown = () => {
    const selected = document.getElementById('global-month').value;
    let html = '';
    for (let m = 1; m <= 12; m++) {
        const val = String(m).padStart(2, '0');
        const isSelected = val === String(selected);
        html += `
            <div onclick="selectMonth('${val}')" 
                 class="px-4 py-2 text-xs font-bold text-gray-300 hover:bg-purple-500/20 hover:text-white cursor-pointer transition-colors flex justify-between items-center rounded-lg mb-1 ${isSelected ? 'bg-white/5 text-purple-400' : ''}">
                <span>${m}月</span>
                ${isSelected ? '<i class="fas fa-check text-purple-500 text-[10px]"></i>' : ''}
            </div>`;
    }
    document.getElementById('month-picker-dropdown').innerHTML = html;
};
window.selectMonth = (m, refresh = true) => {
    document.getElementById('global-month').value = m;
    document.getElementById('month-picker-label').textContent = `${Number(m)}月`;
    document.getElementById('month-picker-dropdown').classList.add('hidden');
    renderMonthDropdown();
    if(refresh) refreshUI();
};


// --- Import / Export Logic (Chinese Comments) ---

window.triggerImport = () => {
    document.getElementById('import-file').click();
};

window.processImport = (input) => {
    const file = input.files[0];
    if (!file) return;

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async (results) => {
            if (results.errors.length > 0) {
                alert("CSV 解析错误: " + results.errors[0].message);
                return;
            }

            const rows = results.data;
            let importedCount = 0;
            let errorCount = 0;

            // 必填列检查
            const requiredCols = ['Date', 'Symbol', 'Side', 'PnL']; 
            
            const headers = results.meta.fields;
            const missing = requiredCols.filter(c => !headers.includes(c));
            if (missing.length > 0) {
                alert(`CSV 校验失败。缺少列: ${missing.join(', ')}`);
                return;
            }

            if (!confirm(`发现 ${rows.length} 条记录。确认导入？`)) return;

            for (const row of rows) {
                try {
                    // 数据转换与验证
                    const trade = {
                        date: row['Date'] || new Date().toISOString(),
                        pair: (row['Symbol'] || 'UNKNOWN').toUpperCase(),
                        direction: ['Long', 'Short'].includes(row['Side']) ? row['Side'] : 'Long',
                        qty: parseFloat(row['Qty']) || 0,
                        entry: parseFloat(row['Entry']) || 0,
                        exit: parseFloat(row['Exit']) || 0,
                        profit: parseFloat(row['PnL']) || 0,
                        fee: parseFloat(row['Fee']) || 0,
                        r: parseFloat(row['R']) || 0,
                        strategy: row['Strategy'] || '',
                        tags: row['Tags'] || '',
                        tvLink: '' // 默认为空
                    };

                    // 简单逻辑检查
                    if (isNaN(trade.profit)) throw new Error("无效的盈亏数值");

                    await addDoc(collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'trades'), trade);
                    importedCount++;
                } catch (err) {
                    console.error("行导入失败:", row, err);
                    errorCount++;
                }
            }
            
            alert(`导入完成。\n成功: ${importedCount}\n失败: ${errorCount}`);
            input.value = ''; // 重置
        }
    });
};

window.exportToCSV = () => {
    const y = Number(document.getElementById('global-year').value);
    const m = Number(document.getElementById('global-month').value);
    const search = document.getElementById('table-search')?.value.toUpperCase() || "";

    const filtered = allTrades.filter(t => {
        const d = new Date(t.date);
        const matchDate = d.getFullYear() === y && (d.getMonth() + 1) === m;
        const matchSearch = (t.pair + t.strategy + (t.tags||"")).toUpperCase().includes(search);
        return matchDate && matchSearch;
    });

    if (filtered.length === 0) {
        alert("当前筛选条件下无数据可导出。");
        return;
    }

    const csvData = filtered.map(t => ({
        Date: t.date,
        Symbol: t.pair,
        Side: t.direction,
        Qty: t.qty,
        Entry: t.entry,
        Exit: t.exit,
        PnL: t.profit,
        Fee: t.fee,
        R: t.r,
        Strategy: t.strategy,
        Tags: t.tags
    }));

    const csv = Papa.unparse(csvData);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    const filename = `jinmu_trades_export_${y}-${String(m).padStart(2,'0')}.csv`;
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

document.getElementById('chart-mode-view').onclick = () => { 
    chartMode = 'view'; 
    updateChartModeUI(); 
    refreshUI(); 
};
document.getElementById('chart-mode-all').onclick = () => { 
    chartMode = 'all'; 
    updateChartModeUI(); 
    refreshUI(); 
};

function updateChartModeUI() {
    const btnView = document.getElementById('chart-mode-view');
    const btnAll = document.getElementById('chart-mode-all');
    const activeClass = 'bg-purple-500 text-black shadow-lg shadow-purple-500/20';
    const inactiveClass = 'text-gray-400 hover:text-white bg-transparent shadow-none';
    const baseClass = 'px-3 py-1 text-[10px] font-black rounded-md transition-all';
    
    btnView.className = `${baseClass} ${chartMode === 'view' ? activeClass : inactiveClass}`;
    btnAll.className = `${baseClass} ${chartMode === 'all' ? activeClass : inactiveClass}`;
}

// Flatpickr Instance
let datePickerInstance = null;

window.openModal = () => {
    document.getElementById('trade-form').reset();
    document.getElementById('edit-id').value = "";
    
    // Initialize or Update Flatpickr
    const now = new Date();
    if (!datePickerInstance) {
        datePickerInstance = flatpickr("#trade-date", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            time_24hr: true,
            defaultDate: now,
            locale: "zh",
            theme: "dark",
            disableMobile: "true"
        });
    } else {
        datePickerInstance.setDate(now);
    }
    
    document.getElementById('trade-modal').classList.remove('hidden');
};
window.closeModal = () => document.getElementById('trade-modal').classList.add('hidden');

document.getElementById('trade-form').onsubmit = async (e) => {
    e.preventDefault();
    if (!auth.currentUser) return;
    
    // Construct Date from Flatpickr
    const rawDate = document.getElementById('trade-date').value;
    const dateObj = new Date(rawDate);
    const isoDate = !isNaN(dateObj) ? dateObj.toISOString() : new Date().toISOString();

    const trade = { 
        pair: document.getElementById('trade-pair').value.toUpperCase(), 
        date: isoDate,
        direction: document.getElementById('trade-direction').value,
        profit: parseFloat(document.getElementById('trade-profit').value),
        tvLink: document.getElementById('trade-tv-link').value,
        // Defaults for removed fields
        qty: 0, entry: 0, exit: 0, fee: 0, r: 0, strategy: "", tags: ""
    };
    const eid = document.getElementById('edit-id').value;
    if (eid) await updateDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'trades', eid), trade);
    else await addDoc(collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'trades'), trade);
    window.closeModal();
};

window.deleteTrade = async (id) => { 
    if(confirm("确定要删除这条记录吗？")) 
        await deleteDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'trades', id)); 
};

window.editTrade = (id) => {
    const t = allTrades.find(x => x.id === id);
    document.getElementById('edit-id').value = t.id;
    document.getElementById('trade-pair').value = t.pair;
    document.getElementById('trade-direction').value = t.direction;
    document.getElementById('trade-profit').value = t.profit;
    document.getElementById('trade-tv-link').value = t.tvLink || "";
    
    if (!datePickerInstance) {
         datePickerInstance = flatpickr("#trade-date", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            time_24hr: true,
            locale: "zh",
            theme: "dark",
            disableMobile: "true"
        });
    }
    datePickerInstance.setDate(new Date(t.date));
    
    document.getElementById('trade-modal').classList.remove('hidden');
};

document.getElementById('auth-form').onsubmit = async (e) => {
    e.preventDefault();
    try { 
        await signInWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value); 
    } catch (err) { alert("访问被拒绝: " + err.message); }
};
document.getElementById('btn-register').onclick = async () => {
    try { 
        await createUserWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value); 
    } catch (err) { alert("注册失败: " + err.message); }
};
document.getElementById('btn-logout').onclick = () => signOut(auth);

const calcRiskAmount = document.getElementById('calc-risk-amount');
const calcRiskPercent = document.getElementById('calc-risk-percent');
const calcResult = document.getElementById('calc-result');
function updatePositionSize() {
    const risk = parseFloat(calcRiskAmount?.value) || 0;
    const percent = parseFloat(calcRiskPercent?.value) || 0;
    const size = risk > 0 && percent > 0 ? (risk / (percent / 100)) : 0;
    if (calcResult) calcResult.textContent = '$' + size.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
}
if (calcRiskAmount && calcRiskPercent) {
    calcRiskAmount.oninput = updatePositionSize;
    calcRiskPercent.oninput = updatePositionSize;
    updatePositionSize();
}
    </script>
</body>
</html>


















































































